import React, { useState, useEffect, createContext, useContext, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithCustomToken,
  signInAnonymously,
  updateProfile // Import updateProfile
} from 'firebase/auth';
import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, updateDoc, arrayUnion, arrayRemove, doc, setDoc, deleteDoc, orderBy, serverTimestamp } from 'firebase/firestore';
import { Bar } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend
} from 'chart.js';

// Register Chart.js components required for the Bar chart
ChartJS.register(CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend);

// Define a context for Firebase and user authentication
const FirebaseContext = createContext(null);

// Firebase Configuration and Initialization
// Using the user-provided firebaseConfig
const firebaseConfig = {
  apiKey: "AIzaSyDuBXHarpbukYh4EUAn235IIvA4B19jRMI",
  authDomain: "nobeltime-98ea5.firebaseapp.com",
  databaseURL: "https://nobeltime-98ea5-default-rtdb.firebaseio.com",
  projectId: "nobeltime-98ea5",
  storageBucket: "nobeltime-98ea5.firebasestorage.app",
  messagingSenderId: "902117809689",
  appId: "1:902117809689:web:70a05ec306705de51e9488",
  measurementId: "G-YK70TKD9R9"
};

// Use the __app_id provided by the Canvas environment, or a default
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Initialize Firebase app outside of the component to avoid re-initialization
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Custom hook to provide Firebase instances and user info
function useFirebase() {
  const [user, setUser] = useState(null);
  const [userId, setUserId] = useState(null); // Explicit userId state
  const [loadingAuth, setLoadingAuth] = useState(true);
  const [authInitialized, setAuthInitialized] = useState(false); // New state to track initial auth attempt

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setUserId(currentUser?.uid);
      // Only set loadingAuth to false here if initialAuth has already attempted.
      // This prevents flickering if onAuthStateChanged fires before initialAuth.
      if (authInitialized || currentUser) { // If authInitialized is true or a user is already signed in
        setLoadingAuth(false);
        console.log("Auth state changed, loadingAuth set to false. User:", currentUser?.uid);
      } else {
        console.log("Auth state changed, but not yet initialized or no user. Still loading.");
      }
    });

    // Handle initial authentication (custom token or anonymous)
    const initializeAuth = async () => {
      if (!authInitialized) { // Only attempt this once
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
              await signInWithCustomToken(auth, __initial_auth_token);
              console.log("Signed in with custom token.");
            } catch (tokenError) {
              console.warn("Firebase Hint: Custom token mismatch or other token error. Attempting anonymous sign-in.", tokenError);
              // Fallback to anonymous if custom token fails
              try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously after custom token attempt.");
              } catch (anonError) {
                console.error("Error signing in anonymously after custom token failure:", anonError);
                // If anonymous sign-in also fails, ensure loading is false to proceed to WelcomeScreen
                setLoadingAuth(false);
                setAuthInitialized(true); // Mark as initialized to prevent re-attempts
                return; // Exit early if both fail
              }
            }
          } else {
            // No custom token provided, attempt anonymous sign-in
            try {
              await signInAnonymously(auth);
              console.log("Signed in anonymously (no custom token provided).");
            } catch (anonError) {
              console.error("Error signing in anonymously:", anonError);
              // If anonymous sign-in fails, ensure loading is false to proceed to WelcomeScreen
              setLoadingAuth(false);
              setAuthInitialized(true); // Mark as initialized to prevent re-attempts
              return; // Exit early if anonymous fails
            }
          }
        } catch (error) {
          console.error("Unexpected error during initial Firebase sign-in:", error);
        } finally {
          setAuthInitialized(true);
          setLoadingAuth(false);
          console.log("Initial auth attempt completed, loadingAuth set to false.");
        }
      }
    };

    initializeAuth();

    return () => unsubscribe();
  }, [authInitialized]); // Dependency on authInitialized to run only once

  return { db, auth, user, userId, loadingAuth, setUser, setUserId, setLoadingAuth }; // Export setters
}

// Helper for Confirmation Modal (reused)
const ConfirmationModal = ({ message, onClose }) => (
  <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
      <p className="text-lg font-semibold mb-4">{message}</p>
      <button
        onClick={onClose}
        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200"
      >
        OK
      </button>
    </div>
  </div>
);

// === New Component: WelcomeScreen.jsx ===
function WelcomeScreen({ onAuthSuccess }) {
  const { auth, setLoadingAuth, setUser, setUserId } = useContext(FirebaseContext);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);

  const handleAuthAction = async (actionType) => {
    console.log("Attempting auth action:", actionType); // Log start of action
    setLoadingAuth(true);
    setMessage(''); // Clear previous messages

    // Client-side validation for email and password
    if (email.trim() === '') {
      setMessage('Email cannot be empty.');
      setShowConfirmation(true);
      setLoadingAuth(false);
      return;
    }
    if (password.trim() === '') {
      setMessage('Password cannot be empty.');
      setShowConfirmation(true);
      setLoadingAuth(false);
      return;
    }

    try {
      let userCredential;
      if (actionType === 'signIn') {
        userCredential = await signInWithEmailAndPassword(auth, email, password);
        setMessage(`Signed in as ${userCredential.user.email}.`);
      } else if (actionType === 'createAccount') {
        userCredential = await createUserWithEmailAndPassword(auth, email, password);
        setMessage(`Account created for ${userCredential.user.email}.`);
      }
      setUser(userCredential.user);
      setUserId(userCredential.user.uid);

      console.log("Authentication successful. Showing confirmation modal."); // Log success
      setShowConfirmation(true);
      setTimeout(() => {
        onAuthSuccess(); // Transition to the main app after a short delay
      }, 1500); // Give time for the message to be seen
    } catch (error) {
      console.error("Authentication error caught:", error); // Log the full error object
      let errorMessage = "Authentication failed. Please try again.";
      if (error.code === 'auth/invalid-email') {
        errorMessage = "Invalid email address format.";
      } else if (error.code === 'auth/user-disabled') {
        errorMessage = "User account disabled.";
      } else if (error.code === 'auth/user-not-found') {
        errorMessage = "Incorrect email/Gmail."; // Specific message for email
      } else if (error.code === 'auth/wrong-password') {
        errorMessage = "Incorrect password."; // Specific message for password
      } else if (error.code === 'auth/email-already-in-use') {
        errorMessage = "Email already in use. Please sign in instead of creating a new account.";
      } else if (error.code === 'auth/weak-password') {
        errorMessage = "Password is too weak. Please use at least 6 characters.";
      } else if (error.code === 'auth/unauthorized-domain') {
        errorMessage = "Unauthorized domain. Please add this domain to your Firebase project's authorized domains.";
        console.warn("Firebase Error: auth/unauthorized-domain. To fix this, go to your Firebase project settings -> Authentication -> Settings tab -> Authorized domains, and add the domain where your app is hosted. Current origin:", window.location.origin);
      } else {
        // Generic message for other errors, or if Firebase doesn't distinguish between email/password
        errorMessage = "Both email and password incorrect or other authentication issue.";
      }
      console.log("Showing confirmation modal with message:", errorMessage); // Log modal trigger
      setMessage(errorMessage);
      setShowConfirmation(true);
      setLoadingAuth(false);
    }
  };

  return (
    <div className="min-h-screen bg-white flex flex-col items-center justify-center p-4 font-sans">
      <div className="flex flex-col items-center justify-center flex-grow">
        {/* Logo */}
        <div className="w-32 h-32 mb-8">
          <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M90.5 45.1L19.5 5.9C15.8 3.9 11.5 6.6 11.5 10.8V89.2C11.5 93.4 15.8 96.1 19.5 94.1L90.5 54.9C94.2 52.9 94.2 47.1 90.5 45.1Z" fill="url(#paint0_linear)" stroke="#333333" strokeWidth="2"/>
            <defs>
              <linearGradient id="paint0_linear" x1="11.5" y1="50" x2="94.5" y2="50" gradientUnits="userSpaceOnUse">
                <stop stopColor="#FF8C00"/>
                <stop offset="1" stopColor="#FFD700"/>
              </linearGradient>
            </defs>
          </svg>
        </div>

        {/* Motto */}
        <p className="text-gray-700 text-lg mb-8 text-center max-w-sm">
          Study, don't do it alone, do it on YPT with others!
        </p>

        {/* Email Input */}
        <input
          type="email"
          placeholder="Email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          className="w-full max-w-xs py-3 px-4 mb-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-orange-400"
        />
        {/* Password Input */}
        <input
          type="password"
          placeholder="Password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          className="w-full max-w-xs py-3 px-4 mb-6 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-orange-400"
        />

        {/* Buttons */}
        <button
          onClick={() => handleAuthAction('signIn')}
          className="w-full max-w-xs py-3 mb-4 bg-orange-400 text-white font-bold rounded-lg shadow-md hover:bg-orange-500 transition duration-200 text-lg"
        >
          Sign In
        </button>
        <button
          onClick={() => handleAuthAction('createAccount')}
          className="w-full max-w-xs py-3 bg-orange-500 text-white font-bold rounded-lg shadow-md hover:bg-orange-600 transition duration-200 text-lg"
        >
          Create Account
        </button>
      </div>

      {/* Footer Text */}
      <p className="text-gray-400 text-sm mb-4">Palto</p>

      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}


// === File: /src/components/Navbar.jsx ===
// This Navbar is now the bottom navigation bar, controlling activeTab in App.js
function Navbar({ setActiveTab, activeTab }) {
  return (
    <div className="bg-white border-t border-gray-200 p-3 flex justify-around items-center shadow-lg fixed bottom-0 left-0 w-full z-10">
      <div
        className={`flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeTab === 'timer' ? 'text-blue-600' : 'text-gray-500'}`}
        onClick={() => setActiveTab('timer')}
      >
        <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
        <span className="text-xs mt-1">Home</span>
      </div>
      <div
        className={`flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeTab === 'study-group' ? 'text-blue-600' : 'text-gray-500'}`}
        onClick={() => setActiveTab('study-group')}
      >
        <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M3 6a3 3 0 013-3h10a2 2 0 012 2v8a2 2 0 01-2 2H6a3 3 0 01-3-3V6zm4 6a1 1 0 11-2 0 1 1 0 012 0zm1-3a1 1 0 100 2h2a1 1 0 100-2H8zm7-1a1 1 0 11-2 0 1 1 0 012 0z" clipRule="evenodd"></path></svg>
        <span className="text-xs mt-1">Groups</span>
      </div>
      <div
        className={`flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeTab === 'more' ? 'text-blue-600' : 'text-gray-500'}`}
        onClick={() => setActiveTab('more')}
      >
        <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 40*20" xmlns="http://www.w3.org/2000/svg"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z"></path></svg>
        <span className="text-xs mt-1">More</span>
      </div>
    </div>
  );
}


// Function to generate a diverse set of colors
const generateColors = (numColors) => {
  const colors = [];
  for (let i = 0; i < numColors; i++) {
    const hue = (i * 360) / numColors;
    colors.push(`hsl(${hue}, 70%, 55%)`);
  }
  // Add some common colors that might not be hit by HSL evenly
  colors.push('#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#800000', '#008000', '#000080', '#808000', '#800080', '#008080', '#C0C0C0', '#808080', '#404040', '#000000', '#FFFFFF');
  // Shuffle and pick the first numColors if more were generated
  return colors.sort(() => 0.5 - Math.random()).slice(0, numColors);
};

// === New Component: ColorPickerModal.jsx ===
function ColorPickerModal({ onClose, onSelectColor, selectedColor }) {
  const colors = generateColors(50); // Generate 50 diverse colors

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden">
        {/* Header */}
        <div className="flex justify-between items-center p-4 border-b border-gray-200 shadow-sm">
          <h3 className="text-xl font-bold flex-grow text-center text-gray-800">Select Color</h3>
          <button onClick={onClose} className="text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200">
            Done
          </button>
        </div>

        {/* Color Grid */}
        <div className="p-4 grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-3 max-h-80 overflow-y-auto">
          {colors.map((color, index) => (
            <div
              key={index}
              className={`w-8 h-8 rounded-full cursor-pointer flex items-center justify-center transition-transform transform hover:scale-110 shadow-md`}
              style={{ backgroundColor: color, border: `2px solid ${selectedColor === color ? '#3B82F6' : 'transparent'}` }} // Blue border for selected
              onClick={() => onSelectColor(color)}
            >
              {selectedColor === color && (
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7"></path>
                </svg>
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}


// === New Component: AddSubjectModal.jsx ===
function AddSubjectModal({ onClose, onSave, initialSubject = '', initialColor = '#FF8C00', setMessage, setShowConfirmation }) {
  const [subjectName, setSubjectName] = useState(initialSubject);
  const [subjectColor, setSubjectColor] = useState(initialColor); // Default to orange
  const [showColorPicker, setShowColorPicker] = useState(false);

  const handleSave = () => {
    if (subjectName.trim() === '') {
      setMessage('Subject name cannot be empty.');
      setShowConfirmation(true);
      return;
    }
    onSave(subjectName, subjectColor);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-start justify-center z-50 p-4">
      <div className="bg-gray-100 rounded-lg shadow-xl w-full max-w-md mt-8 overflow-hidden">
        {/* Header */}
        <div className="bg-white text-gray-800 p-4 flex justify-between items-center shadow-sm">
          <button onClick={onClose} className="text-gray-600 font-semibold text-lg hover:text-gray-800 transition duration-200">
            Cancel
          </button>
          <h3 className="text-xl font-bold flex-grow text-center">Subject Name</h3>
          <button onClick={handleSave} className="text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200">
            Done
          </button>
        </div>

        {/* Content */}
        <div className="p-4 bg-gray-100">
          {/* Subject Name Input */}
          <div className="mb-6">
            <input
              type="text"
              value={subjectName}
              onChange={(e) => setSubjectName(e.target.value)}
              placeholder="e.g. Math, Science, History..."
              className="w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm"
            />
          </div>

          {/* Subject Color Section */}
          <div
            className="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between cursor-pointer"
            onClick={() => setShowColorPicker(true)}
          >
            <span className="text-gray-700 font-medium text-lg">Subject Color</span>
            <div
              className="w-8 h-8 rounded-full cursor-pointer shadow-md"
              style={{ backgroundColor: subjectColor, border: `2px solid ${subjectColor}` }}
            ></div>
          </div>
        </div>
      </div>

      {showColorPicker && (
        <ColorPickerModal
          onClose={() => setShowColorPicker(false)}
          onSelectColor={(color) => {
            setSubjectColor(color);
            setShowColorPicker(false); // Close picker after selection
          }}
          selectedColor={subjectColor}
        />
      )}
    </div>
  );
}

// === New Component: SubjectMenu.jsx ===
function SubjectMenu({ onClose, onEdit, onDelete, onAddTodo, position }) {
  // position prop will be an object like { x: number, y: number }

  // Use a ref to the menu to calculate its size and adjust position if it goes off-screen
  const menuRef = useRef(null);
  const [adjustedPosition, setAdjustedPosition] = useState(position);

  useEffect(() => {
    if (menuRef.current) {
      const menuRect = menuRef.current.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      let newX = position.x;
      let newY = position.y;

      // Adjust X if menu goes off right edge
      if (menuRect.right > viewportWidth) {
        newX = viewportWidth - menuRect.width - 10; // 10px padding from right
      }
      // Adjust Y if menu goes off bottom edge
      if (menuRect.bottom > viewportHeight) {
        newY = viewportHeight - menuRect.height - 10; // 10px padding from bottom
      }
      // Ensure menu doesn't go off top or left edge
      newX = Math.max(10, newX);
      newY = Math.max(10, newY);

      if (newX !== position.x || newY !== position.y) {
        setAdjustedPosition({ x: newX, y: newY });
      }
    }
  }, [position]); // Recalculate if initial position changes

  return (
    <div
      ref={menuRef}
      className="fixed bg-white rounded-lg shadow-lg py-2 z-50 min-w-[160px]"
      style={{ top: adjustedPosition.y, left: adjustedPosition.x }}
      onClick={(e) => e.stopPropagation()} // Prevent closing when clicking inside menu
    >
      <button
        className="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 transition duration-150"
        onClick={onEdit}
      >
        Edit subject
      </button>
      <button
        className="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 transition duration-150"
        onClick={onDelete}
      >
        Delete subject
      </button>
      <button
        className="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 transition duration-150"
        onClick={onAddTodo}
      >
        + To-do
      </button>
    </div>
  );
}


// === New Component: AddTodoModal.jsx ===
function AddTodoModal({ onClose, onSaveTodo, subjectName, setMessage, setShowConfirmation }) {
  const [todoDescription, setTodoDescription] = useState('');

  const handleSave = () => {
    if (todoDescription.trim() === '') {
      setMessage('To-do description cannot be empty.');
      setShowConfirmation(true);
      return;
    }
    onSaveTodo(todoDescription);
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-start justify-center z-50 p-4">
      <div className="bg-gray-100 rounded-lg shadow-xl w-full max-w-md mt-8 overflow-hidden">
        {/* Header */}
        <div className="bg-white text-gray-800 p-4 flex justify-between items-center shadow-sm">
          <button onClick={onClose} className="text-gray-600 font-semibold text-lg hover:text-gray-800 transition duration-200">
            Cancel
          </button>
          <h3 className="text-xl font-bold flex-grow text-center">Add To-do for {subjectName}</h3>
          <button onClick={handleSave} className="text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200">
            Save
          </button>
        </div>

        {/* Content */}
        <div className="p-4 bg-gray-100">
          <textarea
            value={todoDescription}
            onChange={(e) => setTodoDescription(e.target.value)}
            placeholder="e.g. Finish chapter 3, Practice math problems..."
            className="w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm h-32"
          ></textarea>
        </div>
      </div>
    </div>
  );
}


// === File: /src/pages/Timer.jsx ===
function Timer() {
  const { db, userId, loadingAuth } = useContext(FirebaseContext);
  const [time, setTime] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [subjects, setSubjects] = useState([]); // Array to store multiple subjects
  const [activeSubjectId, setActiveSubjectId] = useState(null); // ID of the currently active subject
  const [intervalId, setIntervalId] = useState(null);
  const [showAddSubjectModal, setShowAddSubjectModal] = useState(false);
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [showSubjectMenu, setShowSubjectMenu] = useState(false);
  const [menuPosition, setMenuPosition] = useState({ x: 0, y: 0 });
  const [selectedSubjectForMenu, setSelectedSubjectForMenu] = useState(null); // Subject object for menu actions
  const [isEditingSubject, setIsEditingSubject] = useState(false); // State to differentiate add/edit
  const [showAddTodoModal, setShowAddTodoModal] = useState(false); // New state for To-do modal
  const [todos, setTodos] = useState([]); // New state for To-do items


  // Fetch subjects from Firestore on component mount
  useEffect(() => {
    if (!db || !userId || loadingAuth) return;

    const subjectsRef = collection(db, `artifacts/${appId}/users/${userId}/studySubjects`);
    const q = query(subjectsRef, where('uid', '==', userId));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedSubjects = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        // Ensure totalStudyTime exists and is a number, default to 0
        totalStudyTime: doc.data().totalStudyTime || 0,
        // Ensure currentSessionTime exists and is a number, default to 0
        currentSessionTime: 0 // Reset current session time when fetched
      }));
      setSubjects(fetchedSubjects);
      // Only set activeSubjectId if it's currently null AND there are subjects
      // This prevents overriding an active subject set by handleSaveSubject
      if (fetchedSubjects.length > 0 && activeSubjectId === null) {
        setActiveSubjectId(fetchedSubjects[0].id);
      } else if (activeSubjectId !== null && !fetchedSubjects.some(sub => sub.id === activeSubjectId)) {
        // If the currently active subject was deleted, clear activeSubjectId
        setActiveSubjectId(null);
      }
    }, (error) => {
      console.error("Error fetching subjects:", error);
      setMessage("Error loading subjects. Please try again.");
      setShowConfirmation(true);
    });

    return () => unsubscribe();
  }, [db, userId, loadingAuth]); // Depend on db, userId, loadingAuth

  // Fetch To-do items for the active subject
  useEffect(() => {
    if (!db || !userId || !activeSubjectId || loadingAuth) {
      setTodos([]); // Clear todos if no active subject or not authenticated
      return;
    }

    const todosRef = collection(db, `artifacts/${appId}/users/${userId}/todos`);
    const q = query(todosRef, where('uid', '==', userId), where('subjectId', '==', activeSubjectId));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedTodos = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setTodos(fetchedTodos.sort((a, b) => a.completed - b.completed || a.createdAt.toDate() - b.createdAt.toDate())); // Sort by completion status, then by creation date
    }, (error) => {
      console.error("Error fetching todos:", error);
      setMessage("Error loading to-do items. Please try again.");
      setShowConfirmation(true);
    });

    return () => unsubscribe();
  }, [db, userId, activeSubjectId, loadingAuth]); // Depend on activeSubjectId to re-fetch when it changes


  // Timer logic for the active subject
  useEffect(() => {
    if (isRunning && activeSubjectId) {
      const id = setInterval(() => {
        setSubjects(prevSubjects =>
          prevSubjects.map(sub =>
            sub.id === activeSubjectId
              ? { ...sub, currentSessionTime: sub.currentSessionTime + 1 }
              : sub
          )
        );
      }, 1000);
      setIntervalId(id);
    } else {
      if (intervalId) {
        clearInterval(intervalId);
        setIntervalId(null);
      }
    }

    return () => {
      if (intervalId) {
        clearInterval(intervalId);
      }
    };
  }, [isRunning, activeSubjectId]);

  // Function to format time into HH:MM:SS
  const formatTime = (totalSeconds) => {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    return [hours, minutes, seconds]
      .map((unit) => String(unit).padStart(2, '0'))
      .join(':');
  };

  // Get the active subject object
  const activeSubject = subjects.find(sub => sub.id === activeSubjectId);
  const currentTotalTime = activeSubject ? activeSubject.currentSessionTime : 0;

  // Start button handler
  const handleStart = (subjectId) => {
    if (!subjectId) {
      setMessage('Please select or add a subject to start.');
      setShowConfirmation(true);
      return;
    }
    setIsRunning(true);
    setActiveSubjectId(subjectId); // Ensure the clicked subject is active
  };

  // Pause button handler
  const handlePause = () => {
    setIsRunning(false);
  };

  // Stop button handler
  const handleStop = async () => {
    setIsRunning(false);
    if (!activeSubjectId) {
      setMessage("No subject selected to stop timer.");
      setShowConfirmation(true);
      return;
    }

    const subjectToUpdate = subjects.find(sub => sub.id === activeSubjectId);

    if (subjectToUpdate && subjectToUpdate.currentSessionTime > 0) {
      try {
        if (!db || !userId) {
          setMessage("Firestore not ready. Please wait for authentication.");
          setShowConfirmation(true);
          return;
        }

        const subjectDocRef = doc(db, `artifacts/${appId}/users/${userId}/studySubjects`, activeSubjectId);
        const newTotalStudyTime = (subjectToUpdate.totalStudyTime || 0) + subjectToUpdate.currentSessionTime;

        await updateDoc(subjectDocRef, {
          totalStudyTime: newTotalStudyTime,
        });

        // Also save the session to the sessions collection
        const sessionsRef = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
        await addDoc(sessionsRef, {
          uid: userId,
          subjectId: activeSubjectId,
          subjectName: subjectToUpdate.name,
          duration: subjectToUpdate.currentSessionTime,
          createdAt: new Date(),
        });

        setMessage(`Session for ${subjectToUpdate.name} saved: ${formatTime(subjectToUpdate.currentSessionTime)}.`);
        setShowConfirmation(true);

        // Reset current session time for the stopped subject
        setSubjects(prevSubjects =>
          prevSubjects.map(sub =>
            sub.id === activeSubjectId
              ? { ...sub, currentSessionTime: 0 }
              : sub
          )
        );
        setActiveSubjectId(null); // Deactivate the subject after stopping
      } catch (error) {
        console.error("Error saving session:", error);
        setMessage("Error saving session. Please try again.");
        setShowConfirmation(true);
      }
    } else {
      setMessage("No study time recorded for the active subject to save.");
      setShowConfirmation(true);
    }
  };

  // Handle saving new subject from the modal
  const handleSaveSubject = async (name, color) => {
    if (!db || !userId) {
      setMessage("Firestore not ready. Please wait for authentication.");
      setShowConfirmation(true);
      return;
    }
    try {
      const subjectsRef = collection(db, `artifacts/${appId}/users/${userId}/studySubjects`);
      if (isEditingSubject && selectedSubjectForMenu) {
        // Update existing subject
        const subjectDocRef = doc(db, `artifacts/${appId}/users/${userId}/studySubjects`, selectedSubjectForMenu.id);
        await updateDoc(subjectDocRef, {
          name: name,
          color: color,
        });
        setMessage(`Subject "${name}" updated!`);
      } else {
        // Add new subject
        const newSubjectDoc = await addDoc(subjectsRef, {
          uid: userId,
          name: name,
          color: color,
          createdAt: new Date(),
          totalStudyTime: 0,
        });
        // Set the newly added subject as active
        setActiveSubjectId(newSubjectDoc.id);
        setMessage(`Subject "${name}" added!`);
      }
      setShowConfirmation(true);
      setIsEditingSubject(false); // Reset edit state
      setSelectedSubjectForMenu(null); // Clear selected subject for menu
    } catch (error) {
      console.error("Error saving/updating subject:", error);
      setMessage("Error saving/updating subject. Please try again.");
      setShowConfirmation(true);
    }
  };

  const handleDeleteSubject = async (subjectId) => {
    if (!db || !userId) {
      setMessage("Firestore not ready. Please wait for authentication.");
      setShowConfirmation(true);
      return;
    }
    try {
      await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/studySubjects`, subjectId));
      setMessage("Subject deleted successfully!");
      setShowConfirmation(true);
      if (activeSubjectId === subjectId) {
        setActiveSubjectId(null); // Clear active subject if deleted
        setIsRunning(false); // Stop timer if active subject is deleted
      }
      setShowSubjectMenu(false); // Close menu after action
    } catch (error) {
      console.error("Error deleting subject:", error);
      setMessage("Error deleting subject. Please try again.");
      setShowConfirmation(true);
    }
  };

  const handleEditSubject = (subject) => {
    setSelectedSubjectForMenu(subject);
    setIsEditingSubject(true);
    setShowAddSubjectModal(true);
    setShowSubjectMenu(false); // Close menu
  };

  const handleAddTodo = (subject) => {
    setSelectedSubjectForMenu(subject);
    setShowAddTodoModal(true); // Open the AddTodoModal
    setShowSubjectMenu(false); // Close subject menu
  };

  const handleSaveTodo = async (description) => {
    if (!db || !userId || !selectedSubjectForMenu?.id) {
      setMessage("Firestore not ready or no subject selected for To-do.");
      setShowConfirmation(true);
      return;
    }
    try {
      const todosRef = collection(db, `artifacts/${appId}/users/${userId}/todos`);
      await addDoc(todosRef, {
        uid: userId,
        subjectId: selectedSubjectForMenu.id,
        description: description,
        completed: false, // Default to not completed
        createdAt: new Date(),
      });
      setMessage(`To-do added for "${selectedSubjectForMenu.name}"!`);
      setShowConfirmation(true);
      setShowAddTodoModal(false); // Close the To-do modal
    } catch (error) {
      console.error("Error saving To-do:", error);
      setMessage("Error saving To-do. Please try again.");
      setShowConfirmation(true);
    }
  };

  const handleToggleTodoComplete = async (todoId, currentStatus) => {
    if (!db || !userId) {
      setMessage("Firestore not ready. Please wait for authentication.");
      setShowConfirmation(true);
      return;
    }
    try {
      const todoDocRef = doc(db, `artifacts/${appId}/users/${userId}/todos`, todoId);
      await updateDoc(todoDocRef, {
        completed: !currentStatus,
      });
      setMessage(`To-do status updated!`);
      setShowConfirmation(true);
    } catch (error) {
      console.error("Error updating To-do status:", error);
      setMessage("Error updating To-do status. Please try again.");
      setShowConfirmation(true);
    }
  };


  const handleThreeDotClick = (e, subject) => {
    e.stopPropagation(); // Prevent triggering the parent div's onClick (setActiveSubjectId)
    setSelectedSubjectForMenu(subject);
    setMenuPosition({ x: e.clientX, y: e.clientY });
    setShowSubjectMenu(true);
  };

  // Close menu if clicked outside
  useEffect(() => {
    const handleClickOutside = () => {
      if (showSubjectMenu) {
        setShowSubjectMenu(false);
        setSelectedSubjectForMenu(null);
      }
    };
    window.addEventListener('click', handleClickOutside);
    return () => window.removeEventListener('click', handleClickOutside);
  }, [showSubjectMenu]);


  if (loadingAuth) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
        <p>Loading authentication...</p>
      </div>
    );
  }

  // Get current date for header
  const today = new Date();
  const options = { weekday: 'short', month: 'numeric', day: 'numeric' };
  const formattedDate = today.toLocaleDateString('en-US', options);

  // Calculate D-Day (placeholder logic, adjust as needed)
  const dDayValue = "D-Day"; // As per image, it's a fixed text. Could be dynamic later.

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
      {/* Top Orange Header Section */}
      <div className="bg-orange-500 text-white p-4 flex flex-col items-center relative">
        <div className="w-full flex justify-between items-center mb-4">
          {/* Hamburger Menu Icon (using SVG for simplicity) */}
          <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <span className="text-sm font-semibold">{formattedDate}</span>
          <span className="text-sm font-semibold">{dDayValue}</span>
        </div>
        <div className="text-6xl font-bold mb-4 tracking-wide">
          {formatTime(currentTotalTime)} {/* Display time of active subject */}
        </div>
        {/* Question Mark Icon (using SVG for simplicity) */}
        <svg className="w-5 h-5 text-white absolute bottom-4 right-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.228 9.247a4.5 4.5 0 011.13-1.897l8.932-8.931a1 1 0 011.414 0l2.121 2.121a1 1 0 010 1.414l-8.931 8.932a4.5 4.5 0 01-1.897 1.13zM12 18v.01M12 12v6"></path>
        </svg>
      </div>

      {/* Tabs Section */}
      <div className="bg-white shadow-md flex justify-around p-3 text-gray-600 font-medium text-lg">
        <div className="flex-1 text-center border-b-2 border-blue-600 pb-2 text-blue-600">Timer</div>
        <div className="flex-1 text-center pb-2">Books</div>
        <div className="flex-1 text-center pb-2">Insights</div>
        <div className="flex-1 text-center pb-2">Planner</div>
      </div>

      {/* Main Content Area */}
      <div className="flex-grow bg-gray-100 p-4">
        {/* Add Subject button */}
        <div className="flex justify-start gap-3 mb-4">
          <button
            onClick={() => {
              setIsEditingSubject(false); // Ensure we're in "add" mode
              setSelectedSubjectForMenu(null); // Clear any pre-selected subject
              setShowAddSubjectModal(true);
            }}
            className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg text-md font-semibold hover:bg-gray-300 transition duration-200"
          >
            + Subject
          </button>
        </div>

        {/* List of Subjects */}
        {subjects.length > 0 ? (
          <div className="w-full max-w-md mx-auto">
            {subjects.map(sub => (
              <div
                key={sub.id}
                className={`flex items-center justify-between py-3 px-4 mb-2 rounded-lg shadow-sm bg-white border ${activeSubjectId === sub.id ? 'border-blue-500' : 'border-gray-200'}`}
                onClick={() => setActiveSubjectId(sub.id)} // Set active subject on click
              >
                <div className="flex items-center">
                  {/* Play/Pause Icon based on timer state and active subject */}
                  {isRunning && activeSubjectId === sub.id ? (
                    <svg onClick={(e) => { e.stopPropagation(); handlePause(); }} className="w-6 h-6 mr-3 cursor-pointer" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style={{ color: sub.color }}><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd"></path></svg>
                  ) : (
                    <svg onClick={(e) => { e.stopPropagation(); handleStart(sub.id); }} className="w-6 h-6 mr-3 cursor-pointer" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style={{ color: sub.color }}><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd"></path></svg>
                  )}
                  <span className="text-gray-800 font-medium text-lg">
                    {sub.name}
                  </span>
                </div>
                <div className="flex items-center">
                  <span className="text-gray-600 text-lg mr-4">
                    {formatTime(sub.currentSessionTime)}
                  </span>
                  {/* Three-dot menu icon */}
                  <svg
                    className="w-5 h-5 text-gray-400 cursor-pointer"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg"
                    onClick={(e) => handleThreeDotClick(e, sub)}
                  >
                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z"></path>
                  </svg>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="text-center text-gray-600 text-lg mt-8">
            <p>No subjects added yet.</p>
            <p>Click "+ Subject" to add your first study subject!</p>
          </div>
        )}

        {/* To-do List for Active Subject */}
        {activeSubjectId && todos.length > 0 && (
          <div className="w-full max-w-md mx-auto mt-6 p-4 bg-white rounded-lg shadow-sm">
            <h4 className="text-lg font-semibold text-gray-800 mb-3">To-dos for {activeSubject?.name}</h4>
            {todos.map(todo => (
              <div key={todo.id} className="flex items-center mb-2">
                <input
                  type="checkbox"
                  checked={todo.completed}
                  onChange={() => handleToggleTodoComplete(todo.id, todo.completed)}
                  className="form-checkbox h-5 w-5 text-blue-600 rounded mr-3 cursor-pointer"
                />
                <span className={`text-gray-700 text-base ${todo.completed ? 'line-through text-gray-500' : ''}`}>
                  {todo.description}
                </span>
              </div>
            ))}
          </div>
        )}
        {activeSubjectId && todos.length === 0 && (
          <div className="w-full max-w-md mx-auto mt-6 p-4 bg-white rounded-lg shadow-sm text-center text-gray-500">
            No to-do items for {activeSubject?.name} yet. Click '+ To-do' in the subject menu to add one!
          </div>
        )}
      </div>

      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}

      {showAddSubjectModal && (
        <AddSubjectModal
          onClose={() => {
            setShowAddSubjectModal(false);
            setIsEditingSubject(false); // Reset edit state on close
            setSelectedSubjectForMenu(null); // Clear selected subject
          }}
          onSave={handleSaveSubject}
          initialSubject={isEditingSubject && selectedSubjectForMenu ? selectedSubjectForMenu.name : ''}
          initialColor={isEditingSubject && selectedSubjectForMenu ? selectedSubjectForMenu.color : '#FF8C00'}
          setMessage={setMessage}
          setShowConfirmation={setShowConfirmation}
        />
      )}

      {showSubjectMenu && selectedSubjectForMenu && (
        <SubjectMenu
          onClose={() => setShowSubjectMenu(false)}
          onEdit={() => handleEditSubject(selectedSubjectForMenu)}
          onDelete={() => handleDeleteSubject(selectedSubjectForMenu.id)}
          onAddTodo={() => handleAddTodo(selectedSubjectForMenu)}
          position={menuPosition}
        />
      )}

      {showAddTodoModal && selectedSubjectForMenu && (
        <AddTodoModal
          onClose={() => setShowAddTodoModal(false)}
          onSaveTodo={handleSaveTodo}
          subjectName={selectedSubjectForMenu.name}
          setMessage={setMessage}
          setShowConfirmation={setShowConfirmation}
        />
      )}
    </div>
  );
}

// === File: /src/pages/Stats.jsx ===
function Stats() {
  const { db, userId, loadingAuth } = useContext(FirebaseContext);
  const [dailyData, setDailyData] = useState({ labels: [], data: [] });
  const [filter, setFilter] = useState('daily');
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);

  useEffect(() => {
    const fetchSessions = async () => {
      if (!db || !userId || loadingAuth) return;

      try {
        const sessionsRef = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
        // Data will be sorted client-side.
        const q = query(sessionsRef, where('uid', '==', userId));
        const snapshot = await getDocs(q);

        const data = {};
        // Sort sessions by createdAt ascending for consistent processing
        const sortedSessions = snapshot.docs
          .map(doc => ({ ...doc.data(), id: doc.id }))
          .sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate()); // Ascending sort for chart display

        sortedSessions.forEach(session => {
          const { duration, createdAt } = session;
          const dateObj = createdAt?.toDate();
          if (!dateObj) return;

          let dateKey;
          if (filter === 'weekly') {
            dateKey = `${dateObj.getFullYear()}-W${getWeekNumber(dateObj)}`;
          } else { // 'daily'
            dateKey = dateObj.toLocaleDateString();
          }

          data[dateKey] = (data[dateKey] || 0) + duration / 60; // Convert seconds to minutes
        });

        const labels = Object.keys(data).sort((a, b) => {
          if (filter === 'weekly') {
            // Sort weekly keys (e.g., "2024-W01" correctly)
            const [yearA, weekA] = a.split('-W').map(Number);
            const [yearB, weekB] = b.split('-W').map(Number);
            if (yearA !== yearB) return yearA - yearB;
            return weekA - weekB;
          } else {
            // Sort daily keys (e.g., "7/1/2024")
            return new Date(a) - new Date(b);
          }
        });
        const values = labels.map(key => data[key]);

        setDailyData({ labels, data: values });
        if (labels.length === 0) {
          setMessage("No study data available. Start a session on the Timer page!");
          setShowConfirmation(true);
        }
      } catch (error) {
        console.error("Error fetching sessions:", error);
        setMessage("Error loading study data. Please try again later.");
        setShowConfirmation(true);
      }
    };

    fetchSessions();
  }, [filter, db, userId, loadingAuth]); // Re-fetch when filter or Firebase state changes

  // Helper function to get week number (ISO week date standard)
  const getWeekNumber = (d) => {
    // Copy date so don't modify original
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    // Set to nearest Thursday: current date + 4 - current day number
    // Make Sunday's day number 7
    date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
    // Get first day of year
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
    // Calculate full weeks to nearest Thursday
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    return weekNo;
  };

  const chartData = {
    labels: dailyData.labels,
    datasets: [
      {
        label: 'Study Time (minutes)',
        data: dailyData.data,
        backgroundColor: 'rgba(59, 130, 246, 0.7)', // Blue-600 with transparency
        borderColor: 'rgba(37, 99, 235, 1)',    // Blue-700
        borderWidth: 1,
        borderRadius: 5, // Adds rounded corners to bars
      }
    ]
  };

  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false, // Allows the chart to fill the container better
    plugins: {
      legend: {
        position: 'top',
        labels: {
          font: {
            size: 14,
            family: 'Inter, sans-serif',
          },
          color: '#333',
        }
      },
      title: {
        display: true,
        text: `Your ${filter === 'weekly' ? 'Weekly' : 'Daily'} Study Time`,
        font: {
          size: 18,
          family: 'Inter, sans-serif',
          weight: 'bold',
        },
        color: '#222',
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            let label = context.dataset.label || '';
            if (label) {
              label += ': ';
            }
            if (context.parsed.y !== null) {
              label += `${context.parsed.y.toFixed(1)} mins`; // Show one decimal place for minutes
            }
            return label;
          }
        }
      }
    },
    scales: {
      x: {
        grid: {
          display: false, // Hide x-axis grid lines
        },
        ticks: {
          font: {
            size: 12,
            family: 'Inter, sans-serif',
          },
          color: '#555',
        }
      },
      y: {
        beginAtZero: true,
        grid: {
          color: '#e0e0e0',
        },
        ticks: {
          font: {
            size: 12,
            family: 'Inter, sans-serif',
          },
          color: '#555',
          callback: function(value) {
            return `${value} mins`; // Add 'mins' to y-axis labels
          }
        }
      }
    }
  };


  if (loadingAuth) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
        <p>Loading authentication...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 p-6 flex flex-col items-center font-sans">
      <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Your Study Statistics</h2>

      <div className="flex gap-4 mb-8">
        <button
          className={`px-6 py-2 rounded-full text-lg font-semibold transition-colors duration-200 shadow-md
            ${filter === 'daily' ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
          onClick={() => setFilter('daily')}
        >
          Daily
        </button>
        <button
          className={`px-6 py-2 rounded-full text-lg font-semibold transition-colors duration-200 shadow-md
            ${filter === 'weekly' ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
          onClick={() => setFilter('weekly')}
        >
          Weekly
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-4xl h-96">
        {dailyData.labels.length > 0 ? (
          <Bar options={chartOptions} data={chartData} />
        ) : (
          <div className="flex items-center justify-center h-full text-gray-600 text-xl">
            No study data available. Start a session on the Timer page!
          </div>
        )}
      </div>
      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}

// === File: /src/pages/Leaderboard.jsx ===
function Leaderboard() {
  const { userId, loadingAuth } = useContext(FirebaseContext);
  // In a full implementation, you would fetch public study data here
  // For now, it's a placeholder.

  if (loadingAuth) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
        <p>Loading authentication...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4 font-sans">
      <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Leaderboard</h2>

      <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg text-center">
        <p className="text-gray-700 text-lg mb-4">
          This is where the global or group leaderboard will be displayed.
        </p>
        <p className="text-gray-600 text-md">
          (Feature under development, stay tuned!)
        </p>
        {userId && (
          <p className="text-gray-500 text-sm mt-6">
            Your User ID: <span className="font-mono bg-gray-100 px-2 py-1 rounded-md text-xs break-all">{userId}</span>
          </p>
        )}
      </div>
    </div>
  );
}

// Helper for Confirmation Modal (reused)
// This is already defined globally, so no need to redefine here.

const groupCategoriesData = [
  { value: 'primary_school', label: 'Primary School' },
  { value: 'secondary_school', label: 'Middle School' },
  { value: 'middle_school', label: 'Secondary School' },
  { value: 'higher_secondary', label: 'Higher Secondary' },
  { value: 'university', label: 'University' },
  { value: 'language_study', label: 'Language study' },
  { value: 'others', label: 'Others' },
];

// === New Component: CategorySelectionModal.jsx ===
function CategorySelectionModal({ onClose, onSelectCategory, selectedCategory }) {
  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div className="bg-white p-0 rounded-lg shadow-xl max-w-md w-full h-3/4 flex flex-col">
        {/* Modal Header */}
        <div className="flex justify-between items-center p-4 border-b border-gray-200 shadow-sm">
          <svg onClick={onClose} className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          <h3 className="text-xl font-bold flex-grow text-center">Choose Category</h3>
          <button
            onClick={onClose} // "Done" simply closes the modal
            className="text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200"
          >
            Done
          </button>
        </div>

        {/* Category List */}
        <div className="flex-grow overflow-y-auto">
          {groupCategoriesData.map((category) => (
            <div
              key={category.value}
              className="flex justify-between items-center p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50"
              onClick={() => {
                onSelectCategory(category.value);
                onClose(); // Close after selection
              }}
            >
              <span className="text-gray-800 text-lg">{category.label}</span>
              {selectedCategory === category.value && (
                <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                </svg>
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// === New Component: DailyGoalSelectionModal.jsx ===
function DailyGoalSelectionModal({ onClose, onSelectGoal, selectedGoal }) {
  const timeOptions = [];
  for (let i = 1; i <= 18; i++) {
    timeOptions.push(`${i} hours per day`);
  }

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div className="bg-white p-0 rounded-lg shadow-xl max-w-md w-full h-3/4 flex flex-col">
        {/* Modal Header */}
        <div className="flex justify-between items-center p-4 border-b border-gray-200 shadow-sm">
          <svg onClick={onClose} className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          <h3 className="text-xl font-bold flex-grow text-center">Select Goal Time</h3>
          <button
            onClick={onClose} // "Done" simply closes the modal
            className="text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200"
          >
            Done
          </button>
        </div>

        {/* Time Options List */}
        <div className="flex-grow overflow-y-auto">
          {timeOptions.map((option) => (
            <div
              key={option}
              className="flex justify-between items-center p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50"
              onClick={() => {
                onSelectGoal(option);
                onClose(); // Close after selection
              }}
            >
              <span className="text-gray-800 text-lg">{option}</span>
              {selectedGoal === option && (
                <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                </svg>
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// === New Component: CapacitySelectionModal.jsx ===
function CapacitySelectionModal({ onClose, onSelectCapacity, selectedCapacity }) {
  const capacityOptions = [];
  for (let i = 2; i <= 100; i++) {
    capacityOptions.push(i);
  }

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
      <div className="bg-white p-0 rounded-lg shadow-xl max-w-md w-full h-3/4 flex flex-col">
        {/* Modal Header */}
        <div className="flex justify-between items-center p-4 border-b border-gray-200 shadow-sm">
          <svg onClick={onClose} className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          <h3 className="text-xl font-bold flex-grow text-center">Select Capacity</h3>
          <button
            onClick={onClose} // "Done" simply closes the modal
            className="text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200"
          >
            Done
          </button>
        </div>

        {/* Capacity Options List */}
        <div className="flex-grow overflow-y-auto">
          {capacityOptions.map((option) => (
            <div
              key={option}
              className="flex justify-between items-center p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50"
              onClick={() => {
                onSelectCapacity(option);
                onClose(); // Close after selection
              }}
            >
              <span className="text-gray-800 text-lg">{`${option} people`}</span>
              {selectedCapacity === option && (
                <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                </svg>
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}


// === New Component: CreateGroupPage.jsx ===
function CreateGroupPage({ onBack, onGroupCreated }) {
  const { db, userId, loadingAuth } = useContext(FirebaseContext);
  const [newGroupName, setNewGroupName] = useState('');
  const [newGroupPassword, setNewGroupPassword] = useState('');
  const [newGroupDailyGoal, setNewGroupDailyGoal] = useState('0h 0m');
  const [newGroupCapacity, setNewGroupCapacity] = useState(0);
  const [newGroupDescription, setNewGroupDescription] = useState('');
  const [newGroupCategory, setNewGroupCategory] = useState('others');
  const [showCategorySelectionModal, setShowCategorySelectionModal] = useState(false);
  const [showDailyGoalSelectionModal, setShowDailyGoalSelectionModal] = useState(false);
  const [showCapacitySelectionModal, setShowCapacitySelectionModal] = useState(false);
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);

  const handleCreateGroup = async () => {
    if (newGroupName.trim() === '') {
      setMessage("Group name cannot be empty.");
      setShowConfirmation(true);
      return;
    }
    const groupNameLength = newGroupName.trim().length;
    if (groupNameLength < 5 || groupNameLength > 30) {
      setMessage("Group name must be between 5 and 30 characters long.");
      setShowConfirmation(true);
      return;
    }
    if (!userId) {
      setMessage("Authentication not ready. Please wait.");
      setShowConfirmation(true);
      return;
    }
    if (newGroupCapacity < 2 || newGroupCapacity > 100) {
      setMessage("Capacity must be between 2 and 100 people.");
      setShowConfirmation(true);
      return;
    }
    if (newGroupCategory === 'others' || newGroupCategory === '') {
      setMessage("Please select a group category.");
      setShowConfirmation(true);
      return;
    }
    if (newGroupDailyGoal === '0h 0m' || newGroupDailyGoal === '') {
      setMessage("Please select a daily time goal.");
      setShowConfirmation(true);
      return;
    }
    if (newGroupDescription.length > 250) { // New validation for description length
      setMessage("Group description cannot exceed 250 characters.");
      setShowConfirmation(true);
      return;
    }


    try {
      const groupsRef = collection(db, `artifacts/${appId}/public/data/studyGroups`);
      await addDoc(groupsRef, {
        name: newGroupName.trim(),
        password: newGroupPassword.trim(),
        description: newGroupDescription.trim(),
        members: [userId],
        maxMembers: newGroupCapacity,
        category: newGroupCategory,
        dailyGoal: newGroupDailyGoal,
        createdAt: new Date(),
        attendance: '0',
        studyTime: '0h 0m',
        leaderId: userId
      });
      setMessage("Study group created successfully!");
      setShowConfirmation(true);
      // Reset form fields after successful creation
      setNewGroupName('');
      setNewGroupPassword('');
      setNewGroupDailyGoal('0h 0m');
      setNewGroupCapacity(0);
      setNewGroupDescription('');
      setNewGroupCategory('others');
      onGroupCreated(); // Notify parent to refresh
      onBack(); // Go back to available groups view
    } catch (error) {
      console.error("Error creating group:", error);
      setMessage("Failed to create study group. Please try again.");
      setShowConfirmation(true);
    }
  };

  const groupNameLength = newGroupName.trim().length;
  const isGroupNameInvalid = groupNameLength < 5 || groupNameLength > 30;

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
      {/* Header */}
      <div className="bg-white text-gray-800 p-4 flex justify-between items-center shadow-md">
        <svg onClick={onBack} className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <h3 className="text-xl font-bold flex-grow text-center">Create Group</h3>
        <button
          onClick={handleCreateGroup}
          className="text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200"
        >
          Done
        </button>
      </div>

      {/* Main Content Area */}
      <div className="flex-grow bg-gray-100 p-4 overflow-y-auto">
        <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-auto">
          {/* Input Fields */}
          <div className="mb-4">
            <input
              type="text"
              id="groupName"
              className="w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm"
              value={newGroupName}
              onChange={(e) => setNewGroupName(e.target.value)}
              placeholder="Enter Group Name"
            />
            <span className={`text-xs mt-1 ${isGroupNameInvalid ? 'text-red-500' : 'text-gray-500'}`}>
              {groupNameLength} / 30 characters
            </span>
          </div>
          <div className="mb-6">
            <input
              type="password"
              id="groupPassword"
              className="w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm"
              value={newGroupPassword}
              onChange={(e) => setNewGroupPassword(e.target.value)}
              placeholder="Password (Optional)"
            />
          </div>

          {/* Category, Daily Time Goal, Capacity Sections */}
          <div className="bg-gray-50 rounded-lg shadow-sm mb-6">
            <div
              className="flex justify-between items-center p-4 border-b border-gray-200 cursor-pointer"
              onClick={() => setShowCategorySelectionModal(true)}
            >
              <span className="text-gray-700 font-medium">Category</span>
              <span className="text-gray-500 flex items-center">
                {groupCategoriesData.find(cat => cat.value === newGroupCategory)?.label || 'Choose Category'}
                <svg className="w-5 h-5 ml-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path></svg>
              </span>
            </div>
            <div
              className="flex justify-between items-center p-4 border-b border-gray-200 cursor-pointer"
              onClick={() => setShowDailyGoalSelectionModal(true)}
            >
              <span className="text-gray-700 font-medium">Daily Time Goal</span>
              <span className="text-gray-500 flex items-center">
                {newGroupDailyGoal}
                <svg className="w-5 h-5 ml-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path></svg>
              </span>
            </div>
            <div
              className="flex justify-between items-center p-4 cursor-pointer"
              onClick={() => setShowCapacitySelectionModal(true)}
            >
              <span className="text-gray-700 font-medium">Capacity</span>
              <span className="text-gray-500 flex items-center">
                {newGroupCapacity === 0 ? '0 people' : `${newGroupCapacity} people`}
                <svg className="w-5 h-5 ml-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path></svg>
              </span>
            </div>
          </div>

          {/* Description Textarea */}
          <div className="mb-6">
            <textarea
              id="groupDescription"
              className="w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm h-32"
              value={newGroupDescription}
              onChange={(e) => setNewGroupDescription(e.target.value)}
              placeholder="Describe your group. Include any joining criteria or motivational messages to welcome new members."
              maxLength="250" // Set max length
            ></textarea>
            <span className="text-xs mt-1 text-gray-500">
              {newGroupDescription.length} / 250 characters
            </span>
          </div>
        </div>
      </div>

      {/* Render Category Selection Modal */}
      {showCategorySelectionModal && (
        <CategorySelectionModal
          onClose={() => setShowCategorySelectionModal(false)}
          onSelectCategory={setNewGroupCategory}
          selectedCategory={newGroupCategory}
        />
      )}

      {/* Render Daily Goal Selection Modal */}
      {showDailyGoalSelectionModal && (
        <DailyGoalSelectionModal
          onClose={() => setShowDailyGoalSelectionModal(false)}
          onSelectGoal={setNewGroupDailyGoal}
          selectedGoal={newGroupDailyGoal}
        />
      )}

      {/* Render Capacity Selection Modal */}
      {showCapacitySelectionModal && (
        <CapacitySelectionModal
          onClose={() => setShowCapacitySelectionModal(false)}
          onSelectCapacity={setNewGroupCapacity}
          selectedCapacity={newGroupCapacity}
        />
      )}

      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}


// === New Component: AvailableGroupsView.jsx ===
function AvailableGroupsView({ onBack, onGroupCreated }) {
  const { db, userId, loadingAuth } = useContext(FirebaseContext);
  const [groups, setGroups] = useState([]); // These are ALL public groups
  const [joinedGroupIds, setJoinedGroupIds] = useState(new Set());
  const [showCreateGroupPage, setShowCreateGroupPage] = useState(false); // State to show full Create Group page
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);

  const [filterNewGroups, setFilterNewGroups] = useState(true); // Default to 'New' tab
  const [filterAvailableGroups, setFilterAvailableGroups] = useState(false);
  const [filterPublicGroups, setFilterPublicGroups] = useState(false); // Assuming all are public for now

  // Fetch all public study groups
  useEffect(() => {
    if (!db || !userId || loadingAuth) return;

    const groupsRef = collection(db, `artifacts/${appId}/public/data/studyGroups`);

    const unsubscribe = onSnapshot(groupsRef, (snapshot) => {
      let fetchedGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      // Apply filters
      if (filterNewGroups) {
        fetchedGroups.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
      }
      if (filterAvailableGroups) {
        fetchedGroups = fetchedGroups.filter(group => (group.members?.length || 0) < (group.maxMembers || Infinity));
      }
      // Assuming all groups in this collection are "public" by definition for now.
      // If a 'isPublic' field were added, we'd filter by it here.

      setGroups(fetchedGroups);

      // Update joined group IDs based on current user
      const userJoined = new Set();
      fetchedGroups.forEach(group => {
        if (group.members && group.members.includes(userId)) {
          userJoined.add(group.id);
        }
      });
      setJoinedGroupIds(userJoined);

    }, (error) => {
      console.error("Error fetching study groups:", error);
      setMessage("Error loading study groups. Please try again.");
      setShowConfirmation(true);
    });

    return () => unsubscribe();
  }, [db, userId, loadingAuth, filterNewGroups, filterAvailableGroups, filterPublicGroups]);

  const handleJoinGroup = async (groupId, currentMembers, maxMembers) => {
    if (!userId) {
      setMessage("Authentication not ready. Please wait.");
      setShowConfirmation(true);
      return;
    }
    if (currentMembers >= maxMembers) {
      setMessage("This group has reached its maximum member limit.");
      setShowConfirmation(true);
      return;
    }
    try {
      const groupDocRef = doc(db, `artifacts/${appId}/public/data/studyGroups`, groupId);
      await updateDoc(groupDocRef, {
        members: arrayUnion(userId)
      });
      setMessage("Joined group successfully!");
      setShowConfirmation(true);
    } catch (error) {
      console.error("Error joining group:", error);
      setMessage("Failed to join group. Please try again.");
      setShowConfirmation(true);
    }
  };

  const handleLeaveGroup = async (groupId) => {
    if (!userId) {
      setMessage("Authentication not ready. Please wait.");
      setShowConfirmation(true);
      return;
    }
    try {
      const groupDocRef = doc(db, `artifacts/${appId}/public/data/studyGroups`, groupId);
      await updateDoc(groupDocRef, {
        members: arrayRemove(userId)
      });
      setMessage("Left group successfully!");
      setShowConfirmation(true);
    } catch (error) {
      console.error("Error leaving group:", error);
      setMessage("Failed to leave group. Please try again.");
      setShowConfirmation(true);
    }
  };

  if (loadingAuth) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
        <p>Loading authentication...</p>
      </div>
    );
  }

  // If showCreateGroupPage is true, render the CreateGroupPage component instead of the list
  if (showCreateGroupPage) {
    return <CreateGroupPage onBack={() => setShowCreateGroupPage(false)} onGroupCreated={onGroupCreated} />;
  }

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
      {/* Top Header Section for Study Group */}
      <div className="bg-white text-gray-800 p-4 flex justify-between items-center shadow-md">
        <svg onClick={onBack} className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <div className="flex-grow text-center">
          <h2 className="text-xl font-bold">Study Group</h2>
        </div>
        <svg className="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd"></path></svg>
      </div>

      {/* Tabs for New, Attendance, Studytime, Mission, Leader */}
      <div className="bg-white shadow-md flex justify-around p-3 text-gray-600 font-medium text-lg border-b border-gray-200">
        <div className="flex-1 text-center border-b-2 border-blue-600 pb-2 text-blue-600">New</div>
        <div className="flex-1 text-center pb-2">Attendance</div>
        <div className="flex-1 text-center pb-2">Studytime</div>
        <div className="flex-1 text-center pb-2">Mission</div>
        <div className="flex-1 text-center pb-2">Leader</div>
      </div>

      {/* Filter Options for New Tab */}
      <div className="bg-white p-3 flex justify-end items-center text-gray-700 text-sm border-b border-gray-200">
        <span className="mr-4">* The groups will be listed according to the order in which they were created.</span>
        <label className="inline-flex items-center mr-4">
          <input
            type="checkbox"
            className="form-checkbox h-4 w-4 text-blue-600 rounded"
            checked={filterAvailableGroups}
            onChange={() => setFilterAvailableGroups(!filterAvailableGroups)}
          />
          <span className="ml-2">Available</span>
        </label>
        <label className="inline-flex items-center">
          <input
            type="checkbox"
            className="form-checkbox h-4 w-4 text-blue-600 rounded"
            checked={filterPublicGroups}
            onChange={() => setFilterPublicGroups(!filterPublicGroups)}
          />
          <span className="ml-2">Public</span>
        </label>
      </div>

      {/* Main Content Area: Group List or No Groups Message */}
      <div className="flex-grow bg-gray-100 p-4 flex flex-col items-center">
        {groups.length === 0 ? (
          <div className="flex-grow flex items-center justify-center text-center text-gray-600 text-lg">
            <p>There are no available study groups.</p>
          </div>
        ) : (
          <div className="w-full max-w-4xl">
            {groups.map(group => (
              <div
                key={group.id}
                className={`bg-white p-4 rounded-lg shadow-md mb-4 border ${joinedGroupIds.has(group.id) ? 'border-blue-500' : 'border-gray-200'} hover:shadow-lg transition duration-200 cursor-pointer`}
              >
                <div className="flex justify-between items-start mb-2">
                  <h4 className="font-bold text-lg text-gray-900">{group.name}</h4>
                  <span className="text-sm text-gray-500">
                    {group.createdAt ? `${Math.round((new Date() - group.createdAt.toDate()) / (1000 * 60))}m ago` : ''}
                  </span>
                </div>
                <p className="text-sm text-gray-600 mb-2">{group.description}</p>
                <div className="text-xs text-gray-500 mb-2">
                  <p>Goal: {group.goal || 'N/A'}</p>
                  <p>Members: {group.members ? group.members.length : 0}{group.maxMembers ? `/${group.maxMembers} person` : ''}</p>
                  <p>Attendance: {group.attendance || 'N/A'}%</p>
                  <p>Time: {group.studyTime || 'N/A'}</p>
                  <p>Started on: {group.createdAt ? group.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
                  <p>Leader: {group.leaderId || 'N/A'}</p>
                </div>
                <div className="mt-3 flex justify-end">
                  {joinedGroupIds.has(group.id) ? (
                    <button
                      onClick={(e) => { e.stopPropagation(); handleLeaveGroup(group.id); }}
                      className="px-4 py-1 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition"
                    >
                      Leave
                    </button>
                  ) : (
                    <button
                      onClick={(e) => { e.stopPropagation(); handleJoinGroup(group.id, group.members?.length || 0, group.maxMembers || Infinity); }}
                      className="px-4 py-1 bg-green-500 text-white rounded-md text-sm hover:bg-green-600 transition"
                      disabled={(group.members?.length || 0) >= (group.maxMembers || Infinity)}
                    >
                      Join
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Floating Action Button for Create Group (within AvailableGroupsView) */}
      <button
        onClick={() => setShowCreateGroupPage(true)} // Now opens the full page
        className="fixed bottom-20 right-6 bg-orange-500 text-white p-4 rounded-full shadow-lg hover:bg-orange-600 transition duration-300 transform hover:scale-110 z-20"
        aria-label="Add new study group"
      >
        <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clipRule="evenodd"></path></svg>
      </button>

      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}


// === File: /src/pages/StudyGroup.jsx ===
function StudyGroup({ setSelectedGroupInStudyGroup }) {
  const { db, userId, loadingAuth } = useContext(FirebaseContext);
  const [myGroups, setMyGroups] = useState([]); // Groups the user has joined
  const [showAvailableGroupsView, setShowAvailableGroupsView] = useState(false);
  const [selectedGroup, setSelectedGroup] = useState(null); // State to hold the selected group for detail view
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);

  // Fetch all groups and filter for 'my groups'
  useEffect(() => {
    if (!db || !userId || loadingAuth) return;

    const groupsRef = collection(db, `artifacts/${appId}/public/data/studyGroups`);

    const unsubscribe = onSnapshot(groupsRef, (snapshot) => {
      const allFetchedGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const userJoinedGroups = allFetchedGroups.filter(group =>
        group.members && group.members.includes(userId)
      );
      setMyGroups(userJoinedGroups);
    }, (error) => {
      console.error("Error fetching my study groups:", error);
      setMessage("Error loading your study groups. Please try again.");
      setShowConfirmation(true);
    });

    return () => unsubscribe();
  }, [db, userId, loadingAuth]);

  const handleSelectGroup = (group) => {
    setSelectedGroup(group);
    setSelectedGroupInStudyGroup(group); // Crucially, update the parent state
  };

  // Helper for Confirmation Modal (reused from above)
  // This is already defined globally, so no need to redefine here.

  if (loadingAuth) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
        <p>Loading authentication...</p>
      </div>
    );
  }

  // If a group is selected, show its detail view
  if (selectedGroup) {
    return <GroupDetailView group={selectedGroup} onBack={() => {
      setSelectedGroup(null);
      setSelectedGroupInStudyGroup(null); // Reset parent state when going back
    }} />;
  }

  // If showAvailableGroupsView is true, render the new component
  if (showAvailableGroupsView) {
    return <AvailableGroupsView onBack={() => setShowAvailableGroupsView(false)} onGroupCreated={() => {
      // Optional: Refresh myGroups after a new group is created and joined
      // This is handled by the onSnapshot listener in the useEffect for myGroups,
      // so explicit refresh might not be strictly necessary, but good for clarity.
    }} />;
  }

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
      {/* Top Header Section for My Groups */}
      <div className="bg-white text-gray-800 p-4 flex justify-between items-center shadow-md">
        <div className="flex-grow text-center">
          <h2 className="text-xl font-bold">My Groups</h2>
        </div>
        {/* Bell Icon (Notification) */}
        <svg className="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 110-6 3 3 0 010 6z"></path></svg>
      </div>

      {/* Main Content Area: My Joined Group List or No Groups Message */}
      <div className="flex-grow bg-gray-100 p-4 flex flex-col items-center justify-center">
        {myGroups.length === 0 ? (
          <div className="text-center text-gray-600 text-lg">
            <p>You have not joined any groups.</p>
            <p>Press the + button to add a study group.</p>
          </div>
        ) : (
          <div className="w-full max-w-4xl">
            {myGroups.map(group => (
              <div
                key={group.id}
                className="bg-white p-4 rounded-lg shadow-md mb-4 border border-blue-500 hover:shadow-lg transition duration-200 cursor-pointer"
                onClick={() => handleSelectGroup(group)}
              >
                <div className="flex justify-between items-start mb-2">
                  <h4 className="font-bold text-lg text-gray-900">{group.name}</h4>
                  <span className="text-sm text-gray-500">
                    {group.createdAt ? `${Math.round((new Date() - group.createdAt.toDate()) / (1000 * 60))}m ago` : ''}
                  </span>
                </div>
                <p className="text-sm text-gray-600 mb-2">{group.description}</p>
                <div className="text-xs text-gray-500 mb-2">
                  <p>Goal: {group.goal || 'N/A'}</p>
                  <p>Members: {group.members ? group.members.length : 0}{group.maxMembers ? `/${group.maxMembers} person` : ''}</p>
                  <p>Attendance: {group.attendance || 'N/A'}%</p>
                  <p>Time: {group.studyTime || 'N/A'}</p>
                  <p>Started on: {group.createdAt ? group.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
                </div>
                {/* No join/leave buttons here, as these are already joined groups */}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Floating Action Button for Adding/Viewing Groups */}
      <button
        onClick={() => setShowAvailableGroupsView(true)}
        className="fixed bottom-20 right-6 bg-orange-500 text-white p-4 rounded-full shadow-lg hover:bg-orange-600 transition duration-300 transform hover:scale-110 z-20"
        aria-label="Add new study group"
      >
        <svg className="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clipRule="evenodd"></path></svg>
      </button>

      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}

// === New Component: GroupChat.jsx ===
function GroupChat({ groupId, groupName, onBack }) {
  const { db, userId, user, loadingAuth } = useContext(FirebaseContext);
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);
  const messagesEndRef = useRef(null); // Ref for scrolling to the latest message

  // Fetch messages in real-time
  useEffect(() => {
    if (!db || !groupId || loadingAuth) return;

    const messagesRef = collection(db, `artifacts/${appId}/public/data/groupChats/${groupId}/messages`);
    const q = query(messagesRef, orderBy('timestamp')); // Order by timestamp

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedMessages = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setMessages(fetchedMessages);
    }, (error) => {
      console.error("Error fetching messages:", error);
      setMessage("Error loading chat messages. Please try again.");
      setShowConfirmation(true);
    });

    return () => unsubscribe();
  }, [db, groupId, loadingAuth]);

  // Scroll to the latest message whenever messages update
  useEffect(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
    }
  }, [messages]);

  const handleSendMessage = async () => {
    if (newMessage.trim() === '') {
      setMessage("Message cannot be empty.");
      setShowConfirmation(true);
      return;
    }
    if (!db || !userId) {
      setMessage("Authentication not ready. Cannot send message.");
      setShowConfirmation(true);
      return;
    }

    try {
      const messagesRef = collection(db, `artifacts/${appId}/public/data/groupChats/${groupId}/messages`);
      await addDoc(messagesRef, {
        senderId: userId,
        senderName: user?.displayName || `User-${userId.substring(0, 4)}`, // Use display name or a truncated ID
        text: newMessage.trim(),
        timestamp: serverTimestamp(), // Use server timestamp for consistency
      });
      setNewMessage(''); // Clear input after sending
    } catch (error) {
      console.error("Error sending message:", error);
      setMessage("Failed to send message. Please try again.");
      setShowConfirmation(true);
    }
  };

  if (loadingAuth) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
        <p>Loading authentication...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
      {/* Header */}
      <div className="bg-white text-gray-800 p-4 flex justify-between items-center shadow-md">
        <svg onClick={onBack} className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <h2 className="text-xl font-bold flex-grow text-center">Group Chat</h2>
        <div className="flex items-center space-x-4">
          {/* Bell Icon */}
          <svg className="w-6 h-6 text-gray-600 cursor-pointer" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 110-6 3 3 0 010 6z"></path></svg>
          {/* Info Icon */}
          <svg className="w-6 h-6 text-gray-600 cursor-pointer" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2h.01a1 1 0 000-2H9zm1 3a1 1 0 100 2h.01a1 1 0 100-2H10z" clipRule="evenodd"></path></svg>
        </div>
      </div>

      {/* Messages Display Area */}
      <div className="flex-grow overflow-y-auto p-4 space-y-3 pb-20"> {/* pb-20 for input area */}
        {messages.length === 0 ? (
          <div className="text-center text-gray-500 mt-8">
            The first message
          </div>
        ) : (
          messages.map((msg, index) => (
            <div
              key={msg.id || index}
              className={`flex ${msg.senderId === userId ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-[70%] p-3 rounded-lg shadow-sm ${
                  msg.senderId === userId
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-white text-gray-800 rounded-bl-none'
                }`}
              >
                <p className="text-sm font-semibold mb-1">
                  {msg.senderId === userId ? 'You' : msg.senderName}
                </p>
                <p className="text-base">{msg.text}</p>
                {msg.timestamp && (
                  <span className="text-xs opacity-75 mt-1 block">
                    {new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                  </span>
                )}
              </div>
            </div>
          ))
        )}
        <div ref={messagesEndRef} /> {/* Empty div to scroll to */}
      </div>

      {/* Message Input Area */}
      <div className="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 flex items-center shadow-lg z-10">
        <input
          type="text"
          value={newMessage}
          onChange={(e) => setNewMessage(e.target.value)}
          onKeyPress={(e) => {
            if (e.key === 'Enter') {
              handleSendMessage();
            }
          }}
          placeholder="Message..."
          className="flex-grow p-3 rounded-full bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
        />
        <button
          onClick={handleSendMessage}
          className="ml-3 p-3 bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center"
        >
          <svg className="w-6 h-6 transform rotate-45" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l.445-.445.42.42a1 1 0 001.414 0l1.414-1.414.42.42a1 1 0 001.414 0l1.414-1.414.42.42a1 1 0 001.414 0l.445-.445A1 1 0 0018.894 2.553z"></path></svg>
        </button>
      </div>
      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}


// === New Component: GroupDetailView.jsx ===
function GroupDetailView({ group, onBack }) {
  const { userId, user, loadingAuth } = useContext(FirebaseContext);
  const [activeSubTab, setActiveSubTab] = useState('home'); // 'home', 'attendance', 'rankings', 'invite', 'chat'
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);

  // Use the actual group.members array instead of a hardcoded list
  const members = group.members || [];

  // Placeholder for member study times and icons - this would ideally be fetched from a 'profiles' or 'user_data' collection
  const getMemberDetails = (memberId, currentUser) => { // Added currentUser parameter
    // For now, return a placeholder. In a real app, you'd fetch this from a user profile collection.
    // You could also store a 'lastActive' timestamp in a user's group membership document
    // to determine "real-time" presence.
    const mockDetails = {
      '1': { name: 'Francis', studyTime: '05:11:17', icon: '' },
      '2': { name: 'Tylg07', studyTime: '02:32:17', icon: '' },
      '3': { name: 'Amite', studyTime: '01:33:39', icon: '' },
      '4': { name: 'Markgeoli', studyTime: '01:21:56', icon: '' },
      '5': { name: 'Salma', studyTime: '01:04:03', icon: '' },
      '6': { name: 'clarisyy', studyTime: '00:54:57', icon: '' },
      '7': { name: 'Elexvg', studyTime: '00:36:28', icon: '' },
      '8': { name: 'spherical.rat', studyTime: '00:31:35', icon: '' },
      '9': { name: 'bbyyunseul', studyTime: '00:21:47', icon: '' },
      // Use a more dynamic way to assign the current user's ID to 'nobel134'
      // This is a placeholder for demonstration.
      [userId]: { name: currentUser?.displayName || `You (${memberId.substring(0, 4)})`, studyTime: '00:00:00', icon: '' },
      '11': { name: 'Flamme.A.W.', studyTime: '00:00:00', icon: '' },
      '12': { name: 'high achiever', studyTime: '00:00:00', icon: '' },
      '13': { name: 'z_m759', studyTime: '00:00:00', icon: '' },
      '14': { name: '+Tylg', studyTime: '00:00:00', icon: '' },
      '15': { name: 'JakubW', studyTime: '00:00:00', icon: '' },
      '16': { name: 'kasper', studyTime: '00:00:00', icon: '' },
      '17': { name: 'henriz', studyTime: '00:00:00', icon: '' },
      '18': { name: 'zuzup', studyTime: '00:00:00', icon: '' },
      '19': { name: 'ChlaaaD', studyTime: '00:00:00', icon: '' },
      '20': { name: 'Aminacore', studyTime: '00:00:00', icon: '' },
    };
    return mockDetails[memberId] || { name: `User-${memberId.substring(0, 4)}`, studyTime: '00:00:00', icon: '' };
  };


  if (loadingAuth) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
        <p>Loading authentication...</p>
      </div>
    );
  }

  const handleSubTabClick = (tabName) => {
    setActiveSubTab(tabName);
    // Removed the message/confirmation for tab clicks as they are now functional
  };

  const renderGroupContent = () => {
    switch (activeSubTab) {
      case 'home':
        return (
          <>
            {/* Group Introduction/Rules */}
            <div className="bg-white p-4 mx-4 mt-4 rounded-lg shadow-md flex justify-between items-center text-gray-700 cursor-pointer">
              <span>Group Introduction/Rules</span>
              <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"></path></svg>
            </div>

            {/* Removed the "Studying X members" header for now, as real-time tracking is not implemented */}
            {/* <div className="text-md text-gray-600 px-4 mt-4 mb-2">
              Studying {members.length} members
            </div> */}

            {/* Member Grid */}
            <div className="flex-grow bg-gray-100 p-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 overflow-y-auto pb-16"> {/* Added pb-16 for bottom nav */}
              {members.map(memberId => {
                const memberDetails = getMemberDetails(memberId, user); // Pass user here
                return (
                  <div
                    key={memberId}
                    className={`flex flex-col items-center justify-center p-3 rounded-lg shadow-sm text-center
                      ${memberId === userId ? 'bg-orange-100 border-2 border-orange-400' : 'bg-white border border-gray-200'}`}
                  >
                    <div className="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-2xl mb-2">
                      {memberDetails.icon}
                    </div>
                    <p className="text-sm font-medium text-gray-800 truncate w-full">{memberDetails.name}</p>
                    <p className="text-xs text-gray-500">{memberDetails.studyTime}</p>
                  </div>
                );
              })}
            </div>
          </>
        );
      case 'attendance':
      case 'rankings':
      case 'invite':
        return (
          <div className="flex-grow flex items-center justify-center text-center text-gray-600 text-lg">
            <p>{activeSubTab} functionality to be implemented.</p>
          </div>
        );
      case 'chat':
        return <GroupChat groupId={group.id} groupName={group.name} onBack={onBack} />;
      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
      {/* Header */}
      <div className="bg-white text-gray-800 p-4 flex justify-between items-center shadow-md">
        <svg onClick={onBack} className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <h2 className="text-xl font-bold flex-grow text-center">{group.name}</h2>
        {/* Settings Icon */}
        <svg className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.33.83 2.864 2.334l-.067.223a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.83 3.33-2.334 2.864l-.223-.067a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942.83-3.33 2.334-2.864l.223.067a1.724 1.724 0 002.573-1.066z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </div>

      {/* Render content based on active sub-tab */}
      {renderGroupContent()}

      {/* Bottom Navigation for Group Detail View */}
      {activeSubTab !== 'chat' && ( // Hide this nav if chat is active, as GroupChat has its own
        <div className="bg-white border-t border-gray-200 p-3 flex justify-around items-center shadow-lg fixed bottom-0 left-0 w-full z-10">
          <div
            className={`flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'home' ? 'text-blue-600' : 'text-gray-500'}`}
            onClick={() => handleSubTabClick('home')}
          >
            {/* Home Icon */}
            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 12l9-9 9 9H3zm.75 1.5h16.5V21H3.75v-7.5z"></path></svg>
            <span className="text-xs mt-1">Home</span>
          </div>
          <div
            className={`flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'attendance' ? 'text-blue-600' : 'text-gray-500'}`}
            onClick={() => handleSubTabClick('attendance')}
          >
            {/* Calendar Icon */}
            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM5 7V6h14v1H5z"></path></svg>
            <span className="text-xs mt-1">Attendance</span>
          </div>
          <div
            className={`flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'rankings' ? 'text-blue-600' : 'text-gray-500'}`}
            onClick={() => handleSubTabClick('rankings')}
          >
            {/* Rankings Icon (Bar Chart) */}
            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 22H2V2h2v20zM8 10h2V2h-2v8zm4 8h2V2h-2v16zm4-4h2V2h-2v12zm4-4h2V2h-2v8z"></path></svg>
            <span className="text-xs mt-1">Rankings</span>
          </div>
          <div
            className={`flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'invite' ? 'text-blue-600' : 'text-gray-500'}`}
            onClick={() => handleSubTabClick('invite')}
          >
            {/* Invite Icon (Person with Plus) */}
            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
            <span className="text-xs mt-1">Invite</span>
          </div>
          <div
            className={`flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'chat' ? 'text-blue-600' : 'text-gray-500'}`}
            onClick={() => handleSubTabClick('chat')}
          >
            {/* Chat Icon */}
            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></svg>
            <span className="text-xs mt-1">Chat</span>
          </div>
        </div>
      )}

      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}


// === New Component: SetProfilePage.jsx ===
function SetProfilePage({ onProfileSetupComplete }) {
  const { auth, user, db, userId, setUser } = useContext(FirebaseContext);
  const [displayName, setDisplayName] = useState('');
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);

  useEffect(() => {
    if (user?.displayName) {
      setDisplayName(user.displayName);
    }
  }, [user]);

  const handleSaveProfile = async () => {
    if (displayName.trim() === '') {
      setMessage('Display name cannot be empty.');
      setShowConfirmation(true);
      return;
    }

    if (!user) {
      setMessage('No user authenticated.');
      setShowConfirmation(true);
      return;
    }

    try {
      // Update Firebase Auth profile
      await updateProfile(user, { displayName: displayName.trim() });

      // Optionally, save to Firestore for easier querying and richer profiles
      if (db && userId) {
        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'public'); // Using a subcollection 'profile' and document 'public'
        await setDoc(userDocRef, {
          displayName: displayName.trim(),
          uid: userId,
          // Add other profile fields here if needed, e.g., profilePictureUrl
        }, { merge: true }); // Merge to avoid overwriting other fields if they exist
      }

      setMessage('Profile updated successfully!');
      setShowConfirmation(true);

      // Update the user state in FirebaseContext to reflect the new display name
      // This will trigger onAuthStateChanged in useFirebase, which will then update the user state.
      // We can manually update it here for immediate UI reflection if needed, but onAuthStateChanged is more reliable.
      setUser({ ...user, displayName: displayName.trim() });

      setTimeout(() => {
        onProfileSetupComplete(); // Signal App.js to proceed to the main content
      }, 1500);

    } catch (error) {
      console.error("Error updating profile:", error);
      setMessage(`Failed to update profile: ${error.message}`);
      setShowConfirmation(true);
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4 font-sans">
      <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center">
        <h2 className="text-2xl font-bold text-gray-800 mb-6">Set Up Your Profile</h2>

        {/* Profile Picture Placeholder */}
        <div className="w-24 h-24 bg-blue-200 rounded-full flex items-center justify-center text-5xl text-blue-800 mx-auto mb-6">
          {displayName ? displayName.charAt(0).toUpperCase() : ''}
        </div>

        {/* Display Name Input */}
        <div className="mb-6">
          <label htmlFor="displayName" className="block text-gray-700 text-left text-sm font-medium mb-2">
            Display Name
          </label>
          <input
            type="text"
            id="displayName"
            placeholder="Enter your display name"
            value={displayName}
            onChange={(e) => setDisplayName(e.target.value)}
            className="w-full py-3 px-4 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
            maxLength="20"
          />
          <span className="text-xs text-gray-500 mt-1 block text-right">
            {displayName.length} / 20
          </span>
        </div>

        {/* Save Button */}
        <button
          onClick={handleSaveProfile}
          className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-200 text-lg"
        >
          Save Profile
        </button>
      </div>

      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}


// === File: /src/pages/MorePage.jsx ===
function MorePage({ setActiveTab }) {
  const { userId, user } = useContext(FirebaseContext); // Assuming userId might be used for profile display
  const [message, setMessage] = useState('');
  const [showConfirmation, setShowConfirmation] = useState(false);

  const handleFeatureClick = (featureName) => {
    setMessage(`${featureName} functionality to be implemented.`);
    setShowConfirmation(true);
  };

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col font-sans">
      {/* Header */}
      <div className="bg-white text-gray-800 p-4 flex justify-between items-center shadow-md">
        <h2 className="text-xl font-bold flex-grow text-center">More</h2>
        {/* Settings Icon */}
        <svg className="w-6 h-6 text-gray-600 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.33.83 2.864 2.334l-.067.223a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.83 3.33-2.334 2.864l-.223-.067a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942.83-3.33 2.334-2.864l.223.067a1.724 1.724 0 002.573-1.066z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </div>

      {/* User Profile Section */}
      <div className="bg-white p-4 rounded-lg shadow-md mx-4 mt-4 flex items-center">
        <div className="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mr-4">
          {/* Display first letter of displayName or a default icon */}
          <span className="text-xl text-gray-600">
            {user?.displayName ? user.displayName.charAt(0).toUpperCase() : ''}
          </span>
        </div>
        <div>
          <p className="font-semibold text-lg text-gray-800">{user?.displayName || 'Guest User'}</p>
          <p className="text-sm text-gray-500">No Status Message.</p>
        </div>
        {/* User icon on the right */}
        <div className="ml-auto">
          <svg className="w-8 h-8 text-orange-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
          </svg>
        </div>
      </div>

      {/* AD Placeholder */}
      <div className="text-center text-xs text-gray-400 mt-2 mb-4">
        AD
      </div>

      {/* Menu Options */}
      <div className="bg-white rounded-lg shadow-md mx-4 mb-4 overflow-hidden">
        <div className="border-b border-gray-200">
          <button
            onClick={() => setActiveTab('leaderboard')} // Link to Leaderboard
            className="flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150"
          >
            <svg className="w-6 h-6 mr-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM6.5 9a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm7 0a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm-3.5 6a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" clipRule="evenodd"></path></svg>
            Rankings
          </button>
        </div>
        <div className="border-b border-gray-200">
          <button
            onClick={() => handleFeatureClick('Calendar')}
            className="flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150"
          >
            <svg className="w-6 h-6 mr-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd"></path></svg>
            Calendar
          </button>
        </div>
        <div className="border-b border-gray-200">
          <button
            onClick={() => handleFeatureClick('YPT Store')}
            className="flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150"
          >
            <svg className="w-6 h-6 mr-3 text-orange-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10.586l2 2H14a2 2 0 00-2 2v4a2 2 0 002 2h2a2 2 0 002-2v-4a2 2 0 00-2-2h-1.414l-2-2H4z" clipRule="evenodd"></path></svg>
            YPT Store
          </button>
        </div>
        <div className="border-b border-gray-200">
          <button
            onClick={() => handleFeatureClick('Studicon Settings')}
            className="flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150"
          >
            <svg className="w-6 h-6 mr-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm-1 6a1 1 0 100 2h.01a1 1 0 100-2H10z" clipRule="evenodd"></path></svg>
            Studicon Settings
          </button>
        </div>
        <div className="border-b border-gray-200">
          <button
            onClick={() => handleFeatureClick('Invite Friends')}
            className="flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150"
          >
            <svg className="w-6 h-6 mr-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zm-6 9a3 3 0 100-6 3 3 0 000 6zm7 0a3 3 0 100-6 3 3 0 000 6z"></path></svg>
            Invite Friends
          </button>
        </div>
        <div>
          <button
            onClick={() => handleFeatureClick('Help')}
            className="flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150"
          >
            <svg className="w-6 h-6 mr-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.442C7.26 8.21 6 10.112 6 12a2 2 0 002 2h2a2 2 0 002-2c0-1.888-1.26-3.79-3.133-4.558A1 1 0 0010 7z" clipRule="evenodd"></path></svg>
            Help
          </button>
        </div>
      </div>
      {showConfirmation && (
        <ConfirmationModal message={message} onClose={() => setShowConfirmation(false)} />
      )}
    </div>
  );
}


// === File: /src/App.js ===
export default function App() {
  const [activeTab, setActiveTab] = useState('timer'); // Default active tab
  const [selectedGroupInStudyGroup, setSelectedGroupInStudyGroup] = useState(null); // State to track if a group is selected within StudyGroup
  const firebaseData = useFirebase(); // Use the custom hook to get Firebase instances and user data
  const { user, loadingAuth } = firebaseData;

  const renderContent = () => {
    if (loadingAuth) {
      return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100 text-gray-700">
        <p>Loading authentication...</p>
      </div>
      );
    }

    // If user is not authenticated, show WelcomeScreen
    if (!user) {
      return <WelcomeScreen onAuthSuccess={() => { /* Handled by useFirebase's onAuthStateChanged */ }} />;
    }

    // If user is authenticated but displayName is not set, show SetProfilePage
    if (!user.displayName) {
      return <SetProfilePage onProfileSetupComplete={() => {
        // This callback is triggered when profile setup is complete.
        // The onAuthStateChanged listener in useFirebase will re-evaluate
        // and update the 'user' state, which will then cause App to re-render
        // and show the main content.
      }} />;
    }

    // If user is authenticated and displayName is set, show main app content
    switch (activeTab) {
      case 'timer':
        return <Timer />;
      case 'stats':
        return <Stats />;
      case 'leaderboard':
        return <Leaderboard />;
      case 'study-group':
        // Pass a callback to StudyGroup to update selectedGroupInStudyGroup
        return <StudyGroup setSelectedGroupInStudyGroup={setSelectedGroupInStudyGroup} />;
      case 'more':
        return <MorePage setActiveTab={setActiveTab} />;
      default:
        return <Timer />;
    }
  };

  return (
    // Provide Firebase context to all child components
    <FirebaseContext.Provider value={firebaseData}>
      <div className="min-h-screen bg-gray-100 font-sans text-gray-900 flex flex-col">
        <main className="flex-grow">
          {renderContent()}
        </main>
        {/* Conditionally render the main Navbar */}
        {user && user.displayName && (activeTab !== 'study-group' || !selectedGroupInStudyGroup) ? (
          <Navbar setActiveTab={setActiveTab} activeTab={activeTab} />
        ) : null}
      </div>
    </FirebaseContext.Provider>
  );
}
