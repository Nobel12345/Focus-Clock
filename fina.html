<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YPT Study App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide scrollbar for elements that are intentionally overflowing for specific UI patterns */
        .overflow-y-auto::-webkit-scrollbar {
            display: none;
        }
        .overflow-y-auto {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase Core
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Firebase Auth
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithCustomToken,
            signInAnonymously,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firebase Firestore
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            where,
            getDocs,
            onSnapshot,
            updateDoc,
            arrayUnion,
            arrayRemove,
            doc,
            setDoc,
            deleteDoc,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // React and ReactDOM (from CDN)
        import React, { useState, useEffect, createContext, useContext, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

        // Chart.js (from CDN)
        import {
            Chart as ChartJS,
            CategoryScale,
            LinearScale,
            BarElement,
            Title,
            Tooltip,
            Legend
        } from 'https://esm.sh/chart.js@4.4.1'; // Use a specific version that works with React-Chartjs-2
        import { Bar } from 'https://esm.sh/react-chartjs-2@5.2.0'; // Use a specific version compatible with Chart.js v4

        // Register Chart.js components required for the Bar chart
        ChartJS.register(CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend);

        // Define a context for Firebase and user authentication
        const FirebaseContext = createContext(null);

        // Firebase Configuration and Initialization
        // Using the user-provided firebaseConfig
        const firebaseConfig = {
            apiKey: "AIzaSyDuBXHarpbukYh4EUAn235IIvA4B19jRMI",
            authDomain: "nobeltime-98ea5.firebaseapp.com",
            databaseURL: "https://nobeltime-98ea5-default-rtdb.firebaseio.com",
            projectId: "nobeltime-98ea5",
            storageBucket: "nobeltime-98ea5.firebasestorage.app",
            messagingSenderId: "902117809689",
            appId: "1:902117809689:web:70a05ec306705de51e9488",
            measurementId: "G-YK70TKD9R9"
        };

        // Use the __app_id provided by the Canvas environment, or a default
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase app outside of the component to avoid re-initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Custom hook to provide Firebase instances and user info
        function useFirebase() {
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null); // Explicit userId state
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [authInitialized, setAuthInitialized] = useState(false); // New state to track initial auth attempt

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setUserId(currentUser?.uid);
                    if (authInitialized || currentUser) {
                        setLoadingAuth(false);
                        console.log("Auth state changed, loadingAuth set to false. User:", currentUser?.uid);
                    } else {
                        console.log("Auth state changed, but not yet initialized or no user. Still loading.");
                    }
                });

                const initializeAuth = async () => {
                    if (!authInitialized) {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                try {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                    console.log("Signed in with custom token.");
                                } catch (tokenError) {
                                    console.warn("Firebase Hint: Custom token mismatch or other token error. Attempting anonymous sign-in.", tokenError);
                                    try {
                                        await signInAnonymously(auth);
                                        console.log("Signed in anonymously after custom token attempt.");
                                    } catch (anonError) {
                                        console.error("Error signing in anonymously after custom token failure:", anonError);
                                        setLoadingAuth(false);
                                        setAuthInitialized(true);
                                        return;
                                    }
                                }
                            } else {
                                try {
                                    await signInAnonymously(auth);
                                    console.log("Signed in anonymously (no custom token provided).");
                                } catch (anonError) {
                                    console.error("Error signing in anonymously:", anonError);
                                    setLoadingAuth(false);
                                    setAuthInitialized(true);
                                    return;
                                }
                            }
                        } catch (error) {
                            console.error("Unexpected error during initial Firebase sign-in:", error);
                        } finally {
                            setAuthInitialized(true);
                            setLoadingAuth(false);
                            console.log("Initial auth attempt completed, loadingAuth set to false.");
                        }
                    }
                };

                initializeAuth();

                return () => unsubscribe();
            }, [authInitialized]);

            return { db, auth, user, userId, loadingAuth, setUser, setUserId, setLoadingAuth };
        }

        // Helper for Confirmation Modal
        const ConfirmationModal = ({ message, onClose }) => React.createElement(
            'div',
            { className: 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50' },
            React.createElement(
                'div',
                { className: 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center' },
                React.createElement('p', { className: 'text-lg font-semibold mb-4' }, message),
                React.createElement(
                    'button',
                    {
                        onClick: onClose,
                        className: 'px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200'
                    },
                    'OK'
                )
            )
        );

        // WelcomeScreen Component
        function WelcomeScreen({ onAuthSuccess }) {
            const { auth, setLoadingAuth, setUser, setUserId } = useContext(FirebaseContext);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);

            const handleAuthAction = async (actionType) => {
                console.log("Attempting auth action:", actionType);
                setLoadingAuth(true);
                setMessage('');

                if (email.trim() === '') {
                    setMessage('Email cannot be empty.');
                    setShowConfirmation(true);
                    setLoadingAuth(false);
                    return;
                }
                if (password.trim() === '') {
                    setMessage('Password cannot be empty.');
                    setShowConfirmation(true);
                    setLoadingAuth(false);
                    return;
                }

                try {
                    let userCredential;
                    if (actionType === 'signIn') {
                        userCredential = await signInWithEmailAndPassword(auth, email, password);
                        setMessage(`Signed in as ${userCredential.user.email}.`);
                    } else if (actionType === 'createAccount') {
                        userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        setMessage(`Account created for ${userCredential.user.email}.`);
                    }
                    setUser(userCredential.user);
                    setUserId(userCredential.user.uid);

                    console.log("Authentication successful. Showing confirmation modal.");
                    setShowConfirmation(true);
                    setTimeout(() => {
                        onAuthSuccess();
                    }, 1500);
                } catch (error) {
                    console.error("Authentication error caught:", error);
                    let errorMessage = "Authentication failed. Please try again.";
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email address format.";
                    } else if (error.code === 'auth/user-disabled') {
                        errorMessage = "User account disabled.";
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = "Incorrect email/Gmail.";
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = "Incorrect password.";
                    } else if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "Email already in use. Please sign in instead of creating a new account.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "Password is too weak. Please use at least 6 characters.";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        errorMessage = "Unauthorized domain. Please add this domain to your Firebase project's authorized domains.";
                        console.warn("Firebase Error: auth/unauthorized-domain. To fix this, go to your Firebase project settings -> Authentication -> Settings tab -> Authorized domains, and add the domain where your app is hosted. Current origin:", window.location.origin);
                    } else {
                        errorMessage = "Both email and password incorrect or other authentication issue.";
                    }
                    console.log("Showing confirmation modal with message:", errorMessage);
                    setMessage(errorMessage);
                    setShowConfirmation(true);
                    setLoadingAuth(false);
                }
            };

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-white flex flex-col items-center justify-center p-4 font-sans' },
                React.createElement(
                    'div',
                    { className: 'flex flex-col items-center justify-center flex-grow' },
                    React.createElement(
                        'div',
                        { className: 'w-32 h-32 mb-8' },
                        React.createElement(
                            'svg',
                            { viewBox: '0 0 100 100', fill: 'none', xmlns: 'http://www.w3.org/2000/svg' },
                            React.createElement('path', { d: 'M90.5 45.1L19.5 5.9C15.8 3.9 11.5 6.6 11.5 10.8V89.2C11.5 93.4 15.8 96.1 19.5 94.1L90.5 54.9C94.2 52.9 94.2 47.1 90.5 45.1Z', fill: 'url(#paint0_linear)', stroke: '#333333', strokeWidth: '2' }),
                            React.createElement(
                                'defs',
                                null,
                                React.createElement(
                                    'linearGradient',
                                    { id: 'paint0_linear', x1: '11.5', y1: '50', x2: '94.5', y2: '50', gradientUnits: 'userSpaceOnUse' },
                                    React.createElement('stop', { stopColor: '#FF8C00' }),
                                    React.createElement('stop', { offset: '1', stopColor: '#FFD700' })
                                )
                            )
                        )
                    ),
                    React.createElement(
                        'p',
                        { className: 'text-gray-700 text-lg mb-8 text-center max-w-sm' },
                        'Study, don\'t do it alone, do it on YPT with others!'
                    ),
                    React.createElement('input', {
                        type: 'email',
                        placeholder: 'Email',
                        value: email,
                        onChange: (e) => setEmail(e.target.value),
                        className: 'w-full max-w-xs py-3 px-4 mb-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-orange-400'
                    }),
                    React.createElement('input', {
                        type: 'password',
                        placeholder: 'Password',
                        value: password,
                        onChange: (e) => setPassword(e.target.value),
                        className: 'w-full max-w-xs py-3 px-4 mb-6 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-orange-400'
                    }),
                    React.createElement(
                        'button',
                        {
                            onClick: () => handleAuthAction('signIn'),
                            className: 'w-full max-w-xs py-3 mb-4 bg-orange-400 text-white font-bold rounded-lg shadow-md hover:bg-orange-500 transition duration-200 text-lg'
                        },
                        'Sign In'
                    ),
                    React.createElement(
                        'button',
                        {
                            onClick: () => handleAuthAction('createAccount'),
                            className: 'w-full max-w-xs py-3 bg-orange-500 text-white font-bold rounded-lg shadow-md hover:bg-orange-600 transition duration-200 text-lg'
                        },
                        'Create Account'
                    )
                ),
                React.createElement(
                    'p',
                    { className: 'text-gray-400 text-sm mb-4' },
                    'Palto'
                ),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) })
            );
        }

        // Navbar Component
        function Navbar({ setActiveTab, activeTab }) {
            return React.createElement(
                'div',
                { className: 'bg-white border-t border-gray-200 p-3 flex justify-around items-center shadow-lg fixed bottom-0 left-0 w-full z-10' },
                React.createElement(
                    'div',
                    {
                        className: `flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeTab === 'timer' ? 'text-blue-600' : 'text-gray-500'}`,
                        onClick: () => setActiveTab('timer')
                    },
                    React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z' })),
                    React.createElement('span', { className: 'text-xs mt-1' }, 'Home')
                ),
                React.createElement(
                    'div',
                    {
                        className: `flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeTab === 'study-group' ? 'text-blue-600' : 'text-gray-500'}`,
                        onClick: () => setActiveTab('study-group')
                    },
                    React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M3 6a3 3 0 013-3h10a2 2 0 012 2v8a2 2 0 01-2 2H6a3 3 0 01-3-3V6zm4 6a1 1 0 11-2 0 1 1 0 012 0zm1-3a1 1 0 100 2h2a1 1 0 100-2H8zm7-1a1 1 0 11-2 0 1 1 0 012 0z', clipRule: 'evenodd' })),
                    React.createElement('span', { className: 'text-xs mt-1' }, 'Groups')
                ),
                React.createElement(
                    'div',
                    {
                        className: `flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeTab === 'more' ? 'text-blue-600' : 'text-gray-500'}`,
                        onClick: () => setActiveTab('more')
                    },
                    React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z' })),
                    React.createElement('span', { className: 'text-xs mt-1' }, 'More')
                )
            );
        }

        // Function to generate a diverse set of colors
        const generateColors = (numColors) => {
            const colors = [];
            for (let i = 0; i < numColors; i++) {
                const hue = (i * 360) / numColors;
                colors.push(`hsl(${hue}, 70%, 55%)`);
            }
            colors.push('#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#800000', '#008000', '#000080', '#808000', '#800080', '#008080', '#C0C0C0', '#808080', '#404040', '#000000', '#FFFFFF');
            return colors.sort(() => 0.5 - Math.random()).slice(0, numColors);
        };

        // ColorPickerModal Component
        function ColorPickerModal({ onClose, onSelectColor, selectedColor }) {
            const colors = generateColors(50);

            return React.createElement(
                'div',
                { className: 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4' },
                React.createElement(
                    'div',
                    { className: 'bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden' },
                    React.createElement(
                        'div',
                        { className: 'flex justify-between items-center p-4 border-b border-gray-200 shadow-sm' },
                        React.createElement('h3', { className: 'text-xl font-bold flex-grow text-center text-gray-800' }, 'Select Color'),
                        React.createElement(
                            'button',
                            { onClick: onClose, className: 'text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200' },
                            'Done'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'p-4 grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-3 max-h-80 overflow-y-auto' },
                        colors.map((color, index) =>
                            React.createElement(
                                'div',
                                {
                                    key: index,
                                    className: `w-8 h-8 rounded-full cursor-pointer flex items-center justify-center transition-transform transform hover:scale-110 shadow-md`,
                                    style: { backgroundColor: color, border: `2px solid ${selectedColor === color ? '#3B82F6' : 'transparent'}` },
                                    onClick: () => onSelectColor(color)
                                },
                                selectedColor === color && React.createElement(
                                    'svg',
                                    { className: 'w-5 h-5 text-white', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' },
                                    React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '3', d: 'M5 13l4 4L19 7' })
                                )
                            )
                        )
                    )
                )
            );
        }

        // AddSubjectModal Component
        function AddSubjectModal({ onClose, onSave, initialSubject = '', initialColor = '#FF8C00', setMessage, setShowConfirmation }) {
            const [subjectName, setSubjectName] = useState(initialSubject);
            const [subjectColor, setSubjectColor] = useState(initialColor);
            const [showColorPicker, setShowColorPicker] = useState(false);

            const handleSave = () => {
                if (subjectName.trim() === '') {
                    setMessage('Subject name cannot be empty.');
                    setShowConfirmation(true);
                    return;
                }
                onSave(subjectName, subjectColor);
                onClose();
            };

            return React.createElement(
                'div',
                { className: 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-start justify-center z-50 p-4' },
                React.createElement(
                    'div',
                    { className: 'bg-gray-100 rounded-lg shadow-xl w-full max-w-md mt-8 overflow-hidden' },
                    React.createElement(
                        'div',
                        { className: 'bg-white text-gray-800 p-4 flex justify-between items-center shadow-sm' },
                        React.createElement(
                            'button',
                            { onClick: onClose, className: 'text-gray-600 font-semibold text-lg hover:text-gray-800 transition duration-200' },
                            'Cancel'
                        ),
                        React.createElement('h3', { className: 'text-xl font-bold flex-grow text-center' }, 'Subject Name'),
                        React.createElement(
                            'button',
                            { onClick: handleSave, className: 'text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200' },
                            'Done'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'p-4 bg-gray-100' },
                        React.createElement(
                            'div',
                            { className: 'mb-6' },
                            React.createElement('input', {
                                type: 'text',
                                value: subjectName,
                                onChange: (e) => setSubjectName(e.target.value),
                                placeholder: 'e.g. Math, Science, History...',
                                className: 'w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm'
                            })
                        ),
                        React.createElement(
                            'div',
                            {
                                className: 'bg-white p-4 rounded-lg shadow-sm flex items-center justify-between cursor-pointer',
                                onClick: () => setShowColorPicker(true)
                            },
                            React.createElement('span', { className: 'text-gray-700 font-medium text-lg' }, 'Subject Color'),
                            React.createElement('div', {
                                className: 'w-8 h-8 rounded-full cursor-pointer shadow-md',
                                style: { backgroundColor: subjectColor, border: `2px solid ${subjectColor}` }
                            })
                        )
                    )
                ),
                showColorPicker && React.createElement(ColorPickerModal, {
                    onClose: () => setShowColorPicker(false),
                    onSelectColor: (color) => {
                        setSubjectColor(color);
                        setShowColorPicker(false);
                    },
                    selectedColor: subjectColor
                })
            );
        }

        // SubjectMenu Component
        function SubjectMenu({ onClose, onEdit, onDelete, onAddTodo, position }) {
            const menuRef = useRef(null);
            const [adjustedPosition, setAdjustedPosition] = useState(position);

            useEffect(() => {
                if (menuRef.current) {
                    const menuRect = menuRef.current.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;

                    let newX = position.x;
                    let newY = position.y;

                    if (menuRect.right > viewportWidth) {
                        newX = viewportWidth - menuRect.width - 10;
                    }
                    if (menuRect.bottom > viewportHeight) {
                        newY = viewportHeight - menuRect.height - 10;
                    }
                    newX = Math.max(10, newX);
                    newY = Math.max(10, newY);

                    if (newX !== position.x || newY !== position.y) {
                        setAdjustedPosition({ x: newX, y: newY });
                    }
                }
            }, [position]);

            return React.createElement(
                'div',
                {
                    ref: menuRef,
                    className: 'fixed bg-white rounded-lg shadow-lg py-2 z-50 min-w-[160px]',
                    style: { top: adjustedPosition.y, left: adjustedPosition.x },
                    onClick: (e) => e.stopPropagation()
                },
                React.createElement(
                    'button',
                    {
                        className: 'block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 transition duration-150',
                        onClick: onEdit
                    },
                    'Edit subject'
                ),
                React.createElement(
                    'button',
                    {
                        className: 'block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 transition duration-150',
                        onClick: onDelete
                    },
                    'Delete subject'
                ),
                React.createElement(
                    'button',
                    {
                        className: 'block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 transition duration-150',
                        onClick: onAddTodo
                    },
                    '+ To-do'
                )
            );
        }

        // AddTodoModal Component
        function AddTodoModal({ onClose, onSaveTodo, subjectName, setMessage, setShowConfirmation }) {
            const [todoDescription, setTodoDescription] = useState('');

            const handleSave = () => {
                if (todoDescription.trim() === '') {
                    setMessage('To-do description cannot be empty.');
                    setShowConfirmation(true);
                    return;
                }
                onSaveTodo(todoDescription);
                onClose();
            };

            return React.createElement(
                'div',
                { className: 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-start justify-center z-50 p-4' },
                React.createElement(
                    'div',
                    { className: 'bg-gray-100 rounded-lg shadow-xl w-full max-w-md mt-8 overflow-hidden' },
                    React.createElement(
                        'div',
                        { className: 'bg-white text-gray-800 p-4 flex justify-between items-center shadow-sm' },
                        React.createElement(
                            'button',
                            { onClick: onClose, className: 'text-gray-600 font-semibold text-lg hover:text-gray-800 transition duration-200' },
                            'Cancel'
                        ),
                        React.createElement('h3', { className: 'text-xl font-bold flex-grow text-center' }, 'Add To-do for ', subjectName),
                        React.createElement(
                            'button',
                            { onClick: handleSave, className: 'text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200' },
                            'Save'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'p-4 bg-gray-100' },
                        React.createElement('textarea', {
                            value: todoDescription,
                            onChange: (e) => setTodoDescription(e.target.value),
                            placeholder: 'e.g. Finish chapter 3, Practice math problems...',
                            className: 'w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm h-32'
                        })
                    )
                )
            );
        }

        // Timer Component
        function Timer() {
            const { db, userId, loadingAuth } = useContext(FirebaseContext);
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const [subjects, setSubjects] = useState([]);
            const [activeSubjectId, setActiveSubjectId] = useState(null);
            const [intervalId, setIntervalId] = useState(null);
            const [showAddSubjectModal, setShowAddSubjectModal] = useState(false);
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);
            const [showSubjectMenu, setShowSubjectMenu] = useState(false);
            const [menuPosition, setMenuPosition] = useState({ x: 0, y: 0 });
            const [selectedSubjectForMenu, setSelectedSubjectForMenu] = useState(null);
            const [isEditingSubject, setIsEditingSubject] = useState(false);
            const [showAddTodoModal, setShowAddTodoModal] = useState(false);
            const [todos, setTodos] = useState([]);

            useEffect(() => {
                if (!db || !userId || loadingAuth) return;

                const subjectsRef = collection(db, `artifacts/${appId}/users/${userId}/studySubjects`);
                const q = query(subjectsRef, where('uid', '==', userId));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedSubjects = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        totalStudyTime: doc.data().totalStudyTime || 0,
                        currentSessionTime: 0
                    }));
                    setSubjects(fetchedSubjects);
                    if (fetchedSubjects.length > 0 && activeSubjectId === null) {
                        setActiveSubjectId(fetchedSubjects[0].id);
                    } else if (activeSubjectId !== null && !fetchedSubjects.some(sub => sub.id === activeSubjectId)) {
                        setActiveSubjectId(null);
                    }
                }, (error) => {
                    console.error("Error fetching subjects:", error);
                    setMessage("Error loading subjects. Please try again.");
                    setShowConfirmation(true);
                });

                return () => unsubscribe();
            }, [db, userId, loadingAuth]);

            useEffect(() => {
                if (!db || !userId || !activeSubjectId || loadingAuth) {
                    setTodos([]);
                    return;
                }

                const todosRef = collection(db, `artifacts/${appId}/users/${userId}/todos`);
                const q = query(todosRef, where('uid', '==', userId), where('subjectId', '==', activeSubjectId));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedTodos = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setTodos(fetchedTodos.sort((a, b) => a.completed - b.completed || a.createdAt.toDate() - b.createdAt.toDate()));
                }, (error) => {
                    console.error("Error fetching todos:", error);
                    setMessage("Error loading to-do items. Please try again.");
                    setShowConfirmation(true);
                });

                return () => unsubscribe();
            }, [db, userId, activeSubjectId, loadingAuth]);

            useEffect(() => {
                if (isRunning && activeSubjectId) {
                    const id = setInterval(() => {
                        setSubjects(prevSubjects =>
                            prevSubjects.map(sub =>
                                sub.id === activeSubjectId
                                    ? { ...sub, currentSessionTime: sub.currentSessionTime + 1 }
                                    : sub
                            )
                        );
                    }, 1000);
                    setIntervalId(id);
                } else {
                    if (intervalId) {
                        clearInterval(intervalId);
                        setIntervalId(null);
                    }
                }

                return () => {
                    if (intervalId) {
                        clearInterval(intervalId);
                    }
                };
            }, [isRunning, activeSubjectId]);

            const formatTime = (totalSeconds) => {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                return [hours, minutes, seconds]
                    .map((unit) => String(unit).padStart(2, '0'))
                    .join(':');
            };

            const activeSubject = subjects.find(sub => sub.id === activeSubjectId);
            const currentTotalTime = activeSubject ? activeSubject.currentSessionTime : 0;

            const handleStart = (subjectId) => {
                if (!subjectId) {
                    setMessage('Please select or add a subject to start.');
                    setShowConfirmation(true);
                    return;
                }
                setIsRunning(true);
                setActiveSubjectId(subjectId);
            };

            const handlePause = () => {
                setIsRunning(false);
            };

            const handleStop = async () => {
                setIsRunning(false);
                if (!activeSubjectId) {
                    setMessage("No subject selected to stop timer.");
                    setShowConfirmation(true);
                    return;
                }

                const subjectToUpdate = subjects.find(sub => sub.id === activeSubjectId);

                if (subjectToUpdate && subjectToUpdate.currentSessionTime > 0) {
                    try {
                        if (!db || !userId) {
                            setMessage("Firestore not ready. Please wait for authentication.");
                            setShowConfirmation(true);
                            return;
                        }

                        const subjectDocRef = doc(db, `artifacts/${appId}/users/${userId}/studySubjects`, activeSubjectId);
                        const newTotalStudyTime = (subjectToUpdate.totalStudyTime || 0) + subjectToUpdate.currentSessionTime;

                        await updateDoc(subjectDocRef, {
                            totalStudyTime: newTotalStudyTime,
                        });

                        const sessionsRef = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
                        await addDoc(sessionsRef, {
                            uid: userId,
                            subjectId: activeSubjectId,
                            subjectName: subjectToUpdate.name,
                            duration: subjectToUpdate.currentSessionTime,
                            createdAt: new Date(),
                        });

                        setMessage(`Session for ${subjectToUpdate.name} saved: ${formatTime(subjectToUpdate.currentSessionTime)}.`);
                        setShowConfirmation(true);

                        setSubjects(prevSubjects =>
                            prevSubjects.map(sub =>
                                sub.id === activeSubjectId
                                    ? { ...sub, currentSessionTime: 0 }
                                    : sub
                            )
                        );
                        setActiveSubjectId(null);
                    } catch (error) {
                        console.error("Error saving session:", error);
                        setMessage("Error saving session. Please try again.");
                        setShowConfirmation(true);
                    }
                } else {
                    setMessage("No study time recorded for the active subject to save.");
                    setShowConfirmation(true);
                }
            };

            const handleSaveSubject = async (name, color) => {
                if (!db || !userId) {
                    setMessage("Firestore not ready. Please wait for authentication.");
                    setShowConfirmation(true);
                    return;
                }
                try {
                    const subjectsRef = collection(db, `artifacts/${appId}/users/${userId}/studySubjects`);
                    if (isEditingSubject && selectedSubjectForMenu) {
                        const subjectDocRef = doc(db, `artifacts/${appId}/users/${userId}/studySubjects`, selectedSubjectForMenu.id);
                        await updateDoc(subjectDocRef, {
                            name: name,
                            color: color,
                        });
                        setMessage(`Subject "${name}" updated!`);
                    } else {
                        const newSubjectDoc = await addDoc(subjectsRef, {
                            uid: userId,
                            name: name,
                            color: color,
                            createdAt: new Date(),
                            totalStudyTime: 0,
                        });
                        setActiveSubjectId(newSubjectDoc.id);
                        setMessage(`Subject "${name}" added!`);
                    }
                    setShowConfirmation(true);
                    setIsEditingSubject(false);
                    setSelectedSubjectForMenu(null);
                } catch (error) {
                    console.error("Error saving/updating subject:", error);
                    setMessage("Error saving/updating subject. Please try again.");
                    setShowConfirmation(true);
                }
            };

            const handleDeleteSubject = async (subjectId) => {
                if (!db || !userId) {
                    setMessage("Firestore not ready. Please wait for authentication.");
                    setShowConfirmation(true);
                    return;
                }
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/studySubjects`, subjectId));
                    setMessage("Subject deleted successfully!");
                    setShowConfirmation(true);
                    if (activeSubjectId === subjectId) {
                        setActiveSubjectId(null);
                        setIsRunning(false);
                    }
                    setShowSubjectMenu(false);
                } catch (error) {
                    console.error("Error deleting subject:", error);
                    setMessage("Error deleting subject. Please try again.");
                    setShowConfirmation(true);
                }
            };

            const handleEditSubject = (subject) => {
                setSelectedSubjectForMenu(subject);
                setIsEditingSubject(true);
                setShowAddSubjectModal(true);
                setShowSubjectMenu(false);
            };

            const handleAddTodo = (subject) => {
                setSelectedSubjectForMenu(subject);
                setShowAddTodoModal(true);
                setShowSubjectMenu(false);
            };

            const handleSaveTodo = async (description) => {
                if (!db || !userId || !selectedSubjectForMenu?.id) {
                    setMessage("Firestore not ready or no subject selected for To-do.");
                    setShowConfirmation(true);
                    return;
                }
                try {
                    const todosRef = collection(db, `artifacts/${appId}/users/${userId}/todos`);
                    await addDoc(todosRef, {
                        uid: userId,
                        subjectId: selectedSubjectForMenu.id,
                        description: description,
                        completed: false,
                        createdAt: new Date(),
                    });
                    setMessage(`To-do added for "${selectedSubjectForMenu.name}"!`);
                    setShowConfirmation(true);
                    setShowAddTodoModal(false);
                } catch (error) {
                    console.error("Error saving To-do:", error);
                    setMessage("Error saving To-do. Please try again.");
                    setShowConfirmation(true);
                }
            };

            const handleToggleTodoComplete = async (todoId, currentStatus) => {
                if (!db || !userId) {
                    setMessage("Firestore not ready. Please wait for authentication.");
                    setShowConfirmation(true);
                    return;
                }
                try {
                    const todoDocRef = doc(db, `artifacts/${appId}/users/${userId}/todos`, todoId);
                    await updateDoc(todoDocRef, {
                        completed: !currentStatus,
                    });
                    setMessage(`To-do status updated!`);
                    setShowConfirmation(true);
                } catch (error) {
                    console.error("Error updating To-do status:", error);
                    setMessage("Error updating To-do status. Please try again.");
                    setShowConfirmation(true);
                }
            };

            const handleThreeDotClick = (e, subject) => {
                e.stopPropagation();
                setSelectedSubjectForMenu(subject);
                setMenuPosition({ x: e.clientX, y: e.clientY });
                setShowSubjectMenu(true);
            };

            useEffect(() => {
                const handleClickOutside = () => {
                    if (showSubjectMenu) {
                        setShowSubjectMenu(false);
                        setSelectedSubjectForMenu(null);
                    }
                };
                window.addEventListener('click', handleClickOutside);
                return () => window.removeEventListener('click', handleClickOutside);
            }, [showSubjectMenu]);

            if (loadingAuth) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-gray-100 text-gray-700' },
                    React.createElement('p', null, 'Loading authentication...')
                );
            }

            const today = new Date();
            const options = { weekday: 'short', month: 'numeric', day: 'numeric' };
            const formattedDate = today.toLocaleDateString('en-US', options);
            const dDayValue = "D-Day";

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 flex flex-col font-sans' },
                React.createElement(
                    'div',
                    { className: 'bg-orange-500 text-white p-4 flex flex-col items-center relative' },
                    React.createElement(
                        'div',
                        { className: 'w-full flex justify-between items-center mb-4' },
                        React.createElement('svg', { className: 'w-6 h-6 text-white', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M4 6h16M4 12h16M4 18h16' })),
                        React.createElement('span', { className: 'text-sm font-semibold' }, formattedDate),
                        React.createElement('span', { className: 'text-sm font-semibold' }, dDayValue)
                    ),
                    React.createElement(
                        'div',
                        { className: 'text-6xl font-bold mb-4 tracking-wide' },
                        formatTime(currentTotalTime)
                    ),
                    React.createElement('svg', { className: 'w-5 h-5 text-white absolute bottom-4 right-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M8.228 9.247a4.5 4.5 0 011.13-1.897l8.932-8.931a1 1 0 011.414 0l2.121 2.121a1 1 0 010 1.414l-8.931 8.932a4.5 4.5 0 01-1.897 1.13zM12 18v.01M12 12v6' }))
                ),
                React.createElement(
                    'div',
                    { className: 'bg-white shadow-md flex justify-around p-3 text-gray-600 font-medium text-lg' },
                    React.createElement('div', { className: 'flex-1 text-center border-b-2 border-blue-600 pb-2 text-blue-600' }, 'Timer'),
                    React.createElement('div', { className: 'flex-1 text-center pb-2' }, 'Books'),
                    React.createElement('div', { className: 'flex-1 text-center pb-2' }, 'Insights'),
                    React.createElement('div', { className: 'flex-1 text-center pb-2' }, 'Planner')
                ),
                React.createElement(
                    'div',
                    { className: 'flex-grow bg-gray-100 p-4' },
                    React.createElement(
                        'div',
                        { className: 'flex justify-start gap-3 mb-4' },
                        React.createElement(
                            'button',
                            {
                                onClick: () => {
                                    setIsEditingSubject(false);
                                    setSelectedSubjectForMenu(null);
                                    setShowAddSubjectModal(true);
                                },
                                className: 'px-4 py-2 bg-gray-200 text-gray-800 rounded-lg text-md font-semibold hover:bg-gray-300 transition duration-200'
                            },
                            '+ Subject'
                        )
                    ),
                    subjects.length > 0 ? (
                        React.createElement(
                            'div',
                            { className: 'w-full max-w-md mx-auto' },
                            subjects.map(sub =>
                                React.createElement(
                                    'div',
                                    {
                                        key: sub.id,
                                        className: `flex items-center justify-between py-3 px-4 mb-2 rounded-lg shadow-sm bg-white border ${activeSubjectId === sub.id ? 'border-blue-500' : 'border-gray-200'}`,
                                        onClick: () => setActiveSubjectId(sub.id)
                                    },
                                    React.createElement(
                                        'div',
                                        { className: 'flex items-center' },
                                        isRunning && activeSubjectId === sub.id ? (
                                            React.createElement('svg', { onClick: (e) => { e.stopPropagation(); handlePause(); }, className: 'w-6 h-6 mr-3 cursor-pointer', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg', style: { color: sub.color } }, React.createElement('path', { fillRule: 'evenodd', d: 'M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z', clipRule: 'evenodd' }))
                                        ) : (
                                            React.createElement('svg', { onClick: (e) => { e.stopPropagation(); handleStart(sub.id); }, className: 'w-6 h-6 mr-3 cursor-pointer', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg', style: { color: sub.color } }, React.createElement('path', { fillRule: 'evenodd', d: 'M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z', clipRule: 'evenodd' }))
                                        ),
                                        React.createElement(
                                            'span',
                                            { className: 'text-gray-800 font-medium text-lg' },
                                            sub.name
                                        )
                                    ),
                                    React.createElement(
                                        'div',
                                        { className: 'flex items-center' },
                                        React.createElement(
                                            'span',
                                            { className: 'text-gray-600 text-lg mr-4' },
                                            formatTime(sub.currentSessionTime)
                                        ),
                                        React.createElement('svg', {
                                            className: 'w-5 h-5 text-gray-400 cursor-pointer',
                                            fill: 'currentColor',
                                            viewBox: '0 0 20 20',
                                            xmlns: 'http://www.w3.org/2000/svg',
                                            onClick: (e) => handleThreeDotClick(e, sub)
                                        }, React.createElement('path', { d: 'M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z' }))
                                    )
                                )
                            )
                        )
                    ) : (
                        React.createElement(
                            'div',
                            { className: 'text-center text-gray-600 text-lg mt-8' },
                            React.createElement('p', null, 'No subjects added yet.'),
                            React.createElement('p', null, 'Click "+ Subject" to add your first study subject!')
                        )
                    )
                ),
                activeSubjectId && todos.length > 0 && React.createElement(
                    'div',
                    { className: 'w-full max-w-md mx-auto mt-6 p-4 bg-white rounded-lg shadow-sm' },
                    React.createElement('h4', { className: 'text-lg font-semibold text-gray-800 mb-3' }, 'To-dos for ', activeSubject?.name),
                    todos.map(todo =>
                        React.createElement(
                            'div',
                            { key: todo.id, className: 'flex items-center mb-2' },
                            React.createElement('input', {
                                type: 'checkbox',
                                checked: todo.completed,
                                onChange: () => handleToggleTodoComplete(todo.id, todo.completed),
                                className: 'form-checkbox h-5 w-5 text-blue-600 rounded mr-3 cursor-pointer'
                            }),
                            React.createElement(
                                'span',
                                { className: `text-gray-700 text-base ${todo.completed ? 'line-through text-gray-500' : ''}` },
                                todo.description
                            )
                        )
                    )
                ),
                activeSubjectId && todos.length === 0 && React.createElement(
                    'div',
                    { className: 'w-full max-w-md mx-auto mt-6 p-4 bg-white rounded-lg shadow-sm text-center text-gray-500' },
                    'No to-do items for ', activeSubject?.name, ' yet. Click \'+ To-do\' in the subject menu to add one!'
                ),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) }),
                showAddSubjectModal && React.createElement(AddSubjectModal, {
                    onClose: () => {
                        setShowAddSubjectModal(false);
                        setIsEditingSubject(false);
                        setSelectedSubjectForMenu(null);
                    },
                    onSave: handleSaveSubject,
                    initialSubject: isEditingSubject && selectedSubjectForMenu ? selectedSubjectForMenu.name : '',
                    initialColor: isEditingSubject && selectedSubjectForMenu ? selectedSubjectForMenu.color : '#FF8C00',
                    setMessage: setMessage,
                    setShowConfirmation: setShowConfirmation
                }),
                showSubjectMenu && selectedSubjectForMenu && React.createElement(SubjectMenu, {
                    onClose: () => setShowSubjectMenu(false),
                    onEdit: () => handleEditSubject(selectedSubjectForMenu),
                    onDelete: () => handleDeleteSubject(selectedSubjectForMenu.id),
                    onAddTodo: () => handleAddTodo(selectedSubjectForMenu),
                    position: menuPosition
                }),
                showAddTodoModal && selectedSubjectForMenu && React.createElement(AddTodoModal, {
                    onClose: () => setShowAddTodoModal(false),
                    onSaveTodo: handleSaveTodo,
                    subjectName: selectedSubjectForMenu.name,
                    setMessage: setMessage,
                    setShowConfirmation: setShowConfirmation
                })
            );
        }

        // Stats Component
        function Stats() {
            const { db, userId, loadingAuth } = useContext(FirebaseContext);
            const [dailyData, setDailyData] = useState({ labels: [], data: [] });
            const [filter, setFilter] = useState('daily');
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);

            useEffect(() => {
                const fetchSessions = async () => {
                    if (!db || !userId || loadingAuth) return;

                    try {
                        const sessionsRef = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
                        const q = query(sessionsRef, where('uid', '==', userId));
                        const snapshot = await getDocs(q);

                        const data = {};
                        const sortedSessions = snapshot.docs
                            .map(doc => ({ ...doc.data(), id: doc.id }))
                            .sort((a, b) => a.createdAt.toDate() - b.createdAt.toDate());

                        sortedSessions.forEach(session => {
                            const { duration, createdAt } = session;
                            const dateObj = createdAt?.toDate();
                            if (!dateObj) return;

                            let dateKey;
                            if (filter === 'weekly') {
                                dateKey = `${dateObj.getFullYear()}-W${getWeekNumber(dateObj)}`;
                            } else {
                                dateKey = dateObj.toLocaleDateString();
                            }

                            data[dateKey] = (data[dateKey] || 0) + duration / 60;
                        });

                        const labels = Object.keys(data).sort((a, b) => {
                            if (filter === 'weekly') {
                                const [yearA, weekA] = a.split('-W').map(Number);
                                const [yearB, weekB] = b.split('-W').map(Number);
                                if (yearA !== yearB) return yearA - yearB;
                                return weekA - weekB;
                            } else {
                                return new Date(a) - new Date(b);
                            }
                        });
                        const values = labels.map(key => data[key]);

                        setDailyData({ labels, data: values });
                        if (labels.length === 0) {
                            setMessage("No study data available. Start a session on the Timer page!");
                            setShowConfirmation(true);
                        }
                    } catch (error) {
                        console.error("Error fetching sessions:", error);
                        setMessage("Error loading study data. Please try again later.");
                        setShowConfirmation(true);
                    }
                };

                fetchSessions();
            }, [filter, db, userId, loadingAuth]);

            const getWeekNumber = (d) => {
                const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
                const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
                return weekNo;
            };

            const chartData = {
                labels: dailyData.labels,
                datasets: [
                    {
                        label: 'Study Time (minutes)',
                        data: dailyData.data,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }
                ]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 14,
                                family: 'Inter, sans-serif',
                            },
                            color: '#333',
                        }
                    },
                    title: {
                        display: true,
                        text: `Your ${filter === 'weekly' ? 'Weekly' : 'Daily'} Study Time`,
                        font: {
                            size: 18,
                            family: 'Inter, sans-serif',
                            weight: 'bold',
                        },
                        color: '#222',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += `${context.parsed.y.toFixed(1)} mins`;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                        },
                        ticks: {
                            font: {
                                size: 12,
                                family: 'Inter, sans-serif',
                            },
                            color: '#555',
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#e0e0e0',
                        },
                        ticks: {
                            font: {
                                size: 12,
                                family: 'Inter, sans-serif',
                            },
                            color: '#555',
                            callback: function(value) {
                                return `${value} mins`;
                            }
                        }
                    }
                }
            };

            if (loadingAuth) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-gray-100 text-gray-700' },
                    React.createElement('p', null, 'Loading authentication...')
                );
            }

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 p-6 flex flex-col items-center font-sans' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 text-center' }, 'Your Study Statistics'),
                React.createElement(
                    'div',
                    { className: 'flex gap-4 mb-8' },
                    React.createElement(
                        'button',
                        {
                            className: `px-6 py-2 rounded-full text-lg font-semibold transition-colors duration-200 shadow-md ${filter === 'daily' ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`,
                            onClick: () => setFilter('daily')
                        },
                        'Daily'
                    ),
                    React.createElement(
                        'button',
                        {
                            className: `px-6 py-2 rounded-full text-lg font-semibold transition-colors duration-200 shadow-md ${filter === 'weekly' ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`,
                            onClick: () => setFilter('weekly')
                        },
                        'Weekly'
                    )
                ),
                React.createElement(
                    'div',
                    { className: 'bg-white p-6 rounded-2xl shadow-xl w-full max-w-4xl h-96' },
                    dailyData.labels.length > 0 ? (
                        React.createElement(Bar, { options: chartOptions, data: chartData })
                    ) : (
                        React.createElement(
                            'div',
                            { className: 'flex items-center justify-center h-full text-gray-600 text-xl' },
                            'No study data available. Start a session on the Timer page!'
                        )
                    )
                ),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) })
            );
        }

        // Leaderboard Component
        function Leaderboard() {
            const { userId, loadingAuth } = useContext(FirebaseContext);

            if (loadingAuth) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-gray-100 text-gray-700' },
                    React.createElement('p', null, 'Loading authentication...')
                );
            }

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4 font-sans' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 text-center' }, 'Leaderboard'),
                React.createElement(
                    'div',
                    { className: 'bg-white p-8 rounded-2xl shadow-xl w-full max-w-lg text-center' },
                    React.createElement(
                        'p',
                        { className: 'text-gray-700 text-lg mb-4' },
                        'This is where the global or group leaderboard will be displayed.'
                    ),
                    React.createElement(
                        'p',
                        { className: 'text-gray-600 text-md' },
                        '(Feature under development, stay tuned!)'
                    ),
                    userId && React.createElement(
                        'p',
                        { className: 'text-gray-500 text-sm mt-6' },
                        'Your User ID: ',
                        React.createElement('span', { className: 'font-mono bg-gray-100 px-2 py-1 rounded-md text-xs break-all' }, userId)
                    )
                )
            );
        }

        const groupCategoriesData = [
            { value: 'primary_school', label: 'Primary School' },
            { value: 'secondary_school', label: 'Middle School' },
            { value: 'middle_school', label: 'Secondary School' },
            { value: 'higher_secondary', label: 'Higher Secondary' },
            { value: 'university', label: 'University' },
            { value: 'language_study', label: 'Language study' },
            { value: 'others', label: 'Others' },
        ];

        // CategorySelectionModal Component
        function CategorySelectionModal({ onClose, onSelectCategory, selectedCategory }) {
            return React.createElement(
                'div',
                { className: 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50' },
                React.createElement(
                    'div',
                    { className: 'bg-white p-0 rounded-lg shadow-xl max-w-md w-full h-3/4 flex flex-col' },
                    React.createElement(
                        'div',
                        { className: 'flex justify-between items-center p-4 border-b border-gray-200 shadow-sm' },
                        React.createElement('svg', { onClick: onClose, className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10 19l-7-7m0 0l7-7m-7 7h18' })),
                        React.createElement('h3', { className: 'text-xl font-bold flex-grow text-center' }, 'Choose Category'),
                        React.createElement(
                            'button',
                            {
                                onClick: onClose,
                                className: 'text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200'
                            },
                            'Done'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'flex-grow overflow-y-auto' },
                        groupCategoriesData.map((category) =>
                            React.createElement(
                                'div',
                                {
                                    key: category.value,
                                    className: 'flex justify-between items-center p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50',
                                    onClick: () => {
                                        onSelectCategory(category.value);
                                        onClose();
                                    }
                                },
                                React.createElement('span', { className: 'text-gray-800 text-lg' }, category.label),
                                selectedCategory === category.value && React.createElement(
                                    'svg',
                                    { className: 'w-6 h-6 text-blue-600', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' },
                                    React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M5 13l4 4L19 7' })
                                )
                            )
                        )
                    )
                )
            );
        }

        // DailyGoalSelectionModal Component
        function DailyGoalSelectionModal({ onClose, onSelectGoal, selectedGoal }) {
            const timeOptions = [];
            for (let i = 1; i <= 18; i++) {
                timeOptions.push(`${i} hours per day`);
            }

            return React.createElement(
                'div',
                { className: 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50' },
                React.createElement(
                    'div',
                    { className: 'bg-white p-0 rounded-lg shadow-xl max-w-md w-full h-3/4 flex flex-col' },
                    React.createElement(
                        'div',
                        { className: 'flex justify-between items-center p-4 border-b border-gray-200 shadow-sm' },
                        React.createElement('svg', { onClick: onClose, className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10 19l-7-7m0 0l7-7m-7 7h18' })),
                        React.createElement('h3', { className: 'text-xl font-bold flex-grow text-center' }, 'Select Goal Time'),
                        React.createElement(
                            'button',
                            {
                                onClick: onClose,
                                className: 'text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200'
                            },
                            'Done'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'flex-grow overflow-y-auto' },
                        timeOptions.map((option) =>
                            React.createElement(
                                'div',
                                {
                                    key: option,
                                    className: 'flex justify-between items-center p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50',
                                    onClick: () => {
                                        onSelectGoal(option);
                                        onClose();
                                    }
                                },
                                React.createElement('span', { className: 'text-gray-800 text-lg' }, option),
                                selectedGoal === option && React.createElement(
                                    'svg',
                                    { className: 'w-6 h-6 text-blue-600', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' },
                                    React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M5 13l4 4L19 7' })
                                )
                            )
                        )
                    )
                )
            );
        }

        // CapacitySelectionModal Component
        function CapacitySelectionModal({ onClose, onSelectCapacity, selectedCapacity }) {
            const capacityOptions = [];
            for (let i = 2; i <= 100; i++) {
                capacityOptions.push(i);
            }

            return React.createElement(
                'div',
                { className: 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50' },
                React.createElement(
                    'div',
                    { className: 'bg-white p-0 rounded-lg shadow-xl max-w-md w-full h-3/4 flex flex-col' },
                    React.createElement(
                        'div',
                        { className: 'flex justify-between items-center p-4 border-b border-gray-200 shadow-sm' },
                        React.createElement('svg', { onClick: onClose, className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10 19l-7-7m0 0l7-7m-7 7h18' })),
                        React.createElement('h3', { className: 'text-xl font-bold flex-grow text-center' }, 'Select Capacity'),
                        React.createElement(
                            'button',
                            {
                                onClick: onClose,
                                className: 'text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200'
                            },
                            'Done'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'flex-grow overflow-y-auto' },
                        capacityOptions.map((option) =>
                            React.createElement(
                                'div',
                                {
                                    key: option,
                                    className: 'flex justify-between items-center p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50',
                                    onClick: () => {
                                        onSelectCapacity(option);
                                        onClose();
                                    }
                                },
                                React.createElement('span', { className: 'text-gray-800 text-lg' }, `${option} people`),
                                selectedCapacity === option && React.createElement(
                                    'svg',
                                    { className: 'w-6 h-6 text-blue-600', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' },
                                    React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M5 13l4 4L19 7' })
                                )
                            )
                        )
                    )
                )
            );
        }

        // CreateGroupPage Component
        function CreateGroupPage({ onBack, onGroupCreated }) {
            const { db, userId, loadingAuth } = useContext(FirebaseContext);
            const [newGroupName, setNewGroupName] = useState('');
            const [newGroupPassword, setNewGroupPassword] = useState('');
            const [newGroupDailyGoal, setNewGroupDailyGoal] = useState('0h 0m');
            const [newGroupCapacity, setNewGroupCapacity] = useState(0);
            const [newGroupDescription, setNewGroupDescription] = useState('');
            const [newGroupCategory, setNewGroupCategory] = useState('others');
            const [showCategorySelectionModal, setShowCategorySelectionModal] = useState(false);
            const [showDailyGoalSelectionModal, setShowDailyGoalSelectionModal] = useState(false);
            const [showCapacitySelectionModal, setShowCapacitySelectionModal] = useState(false);
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);

            const handleCreateGroup = async () => {
                if (newGroupName.trim() === '') {
                    setMessage("Group name cannot be empty.");
                    setShowConfirmation(true);
                    return;
                }
                const groupNameLength = newGroupName.trim().length;
                if (groupNameLength < 5 || groupNameLength > 30) {
                    setMessage("Group name must be between 5 and 30 characters long.");
                    setShowConfirmation(true);
                    return;
                }
                if (!userId) {
                    setMessage("Authentication not ready. Please wait.");
                    setShowConfirmation(true);
                    return;
                }
                if (newGroupCapacity < 2 || newGroupCapacity > 100) {
                    setMessage("Capacity must be between 2 and 100 people.");
                    setShowConfirmation(true);
                    return;
                }
                if (newGroupCategory === 'others' || newGroupCategory === '') {
                    setMessage("Please select a group category.");
                    setShowConfirmation(true);
                    return;
                }
                if (newGroupDailyGoal === '0h 0m' || newGroupDailyGoal === '') {
                    setMessage("Please select a daily time goal.");
                    setShowConfirmation(true);
                    return;
                }
                if (newGroupDescription.length > 250) {
                    setMessage("Group description cannot exceed 250 characters.");
                    setShowConfirmation(true);
                    return;
                }

                try {
                    const groupsRef = collection(db, `artifacts/${appId}/public/data/studyGroups`);
                    await addDoc(groupsRef, {
                        name: newGroupName.trim(),
                        password: newGroupPassword.trim(),
                        description: newGroupDescription.trim(),
                        members: [userId],
                        maxMembers: newGroupCapacity,
                        category: newGroupCategory,
                        dailyGoal: newGroupDailyDailyGoal, // Corrected from newGroupDailyGoal
                        createdAt: new Date(),
                        attendance: '0',
                        studyTime: '0h 0m',
                        leaderId: userId
                    });
                    setMessage("Study group created successfully!");
                    setShowConfirmation(true);
                    setNewGroupName('');
                    setNewGroupPassword('');
                    setNewGroupDailyGoal('0h 0m');
                    setNewGroupCapacity(0);
                    setNewGroupDescription('');
                    setNewGroupCategory('others');
                    onGroupCreated();
                    onBack();
                } catch (error) {
                    console.error("Error creating group:", error);
                    setMessage("Failed to create study group. Please try again.");
                    setShowConfirmation(true);
                }
            };

            const groupNameLength = newGroupName.trim().length;
            const isGroupNameInvalid = groupNameLength < 5 || groupNameLength > 30;

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 flex flex-col font-sans' },
                React.createElement(
                    'div',
                    { className: 'bg-white text-gray-800 p-4 flex justify-between items-center shadow-md' },
                    React.createElement('svg', { onClick: onBack, className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10 19l-7-7m0 0l7-7m-7 7h18' })),
                    React.createElement('h3', { className: 'text-xl font-bold flex-grow text-center' }, 'Create Group'),
                    React.createElement(
                        'button',
                        {
                            onClick: handleCreateGroup,
                            className: 'text-blue-600 font-semibold text-lg hover:text-blue-800 transition duration-200'
                        },
                        'Done'
                    )
                ),
                React.createElement(
                    'div',
                    { className: 'flex-grow bg-gray-100 p-4 overflow-y-auto' },
                    React.createElement(
                        'div',
                        { className: 'bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-auto' },
                        React.createElement(
                            'div',
                            { className: 'mb-4' },
                            React.createElement('input', {
                                type: 'text',
                                id: 'groupName',
                                className: 'w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm',
                                value: newGroupName,
                                onChange: (e) => setNewGroupName(e.target.value),
                                placeholder: 'Enter Group Name'
                            }),
                            React.createElement(
                                'span',
                                { className: `text-xs mt-1 ${isGroupNameInvalid ? 'text-red-500' : 'text-gray-500'}` },
                                groupNameLength,
                                ' / 30 characters'
                            )
                        ),
                        React.createElement(
                            'div',
                            { className: 'mb-6' },
                            React.createElement('input', {
                                type: 'password',
                                id: 'groupPassword',
                                className: 'w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm',
                                value: newGroupPassword,
                                onChange: (e) => setNewGroupPassword(e.target.value),
                                placeholder: 'Password (Optional)'
                            })
                        ),
                        React.createElement(
                            'div',
                            { className: 'bg-gray-50 rounded-lg shadow-sm mb-6' },
                            React.createElement(
                                'div',
                                {
                                    className: 'flex justify-between items-center p-4 border-b border-gray-200 cursor-pointer',
                                    onClick: () => setShowCategorySelectionModal(true)
                                },
                                React.createElement('span', { className: 'text-gray-700 font-medium' }, 'Category'),
                                React.createElement(
                                    'span',
                                    { className: 'text-gray-500 flex items-center' },
                                    groupCategoriesData.find(cat => cat.value === newGroupCategory)?.label || 'Choose Category',
                                    React.createElement('svg', { className: 'w-5 h-5 ml-2 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M9 5l7 7-7 7' }))
                                )
                            ),
                            React.createElement(
                                'div',
                                {
                                    className: 'flex justify-between items-center p-4 border-b border-gray-200 cursor-pointer',
                                    onClick: () => setShowDailyGoalSelectionModal(true)
                                },
                                React.createElement('span', { className: 'text-gray-700 font-medium' }, 'Daily Time Goal'),
                                React.createElement(
                                    'span',
                                    { className: 'text-gray-500 flex items-center' },
                                    newGroupDailyGoal,
                                    React.createElement('svg', { className: 'w-5 h-5 ml-2 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M9 5l7 7-7 7' }))
                                )
                            ),
                            React.createElement(
                                'div',
                                {
                                    className: 'flex justify-between items-center p-4 cursor-pointer',
                                    onClick: () => setShowCapacitySelectionModal(true)
                                },
                                React.createElement('span', { className: 'text-gray-700 font-medium' }, 'Capacity'),
                                React.createElement(
                                    'span',
                                    { className: 'text-gray-500 flex items-center' },
                                    newGroupCapacity === 0 ? '0 people' : `${newGroupCapacity} people`,
                                    React.createElement('svg', { className: 'w-5 h-5 ml-2 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M9 5l7 7-7 7' }))
                                )
                            )
                        ),
                        React.createElement(
                            'div',
                            { className: 'mb-6' },
                            React.createElement('textarea', {
                                id: 'groupDescription',
                                className: 'w-full p-3 border border-gray-300 rounded-lg text-lg text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition duration-200 shadow-sm h-32',
                                value: newGroupDescription,
                                onChange: (e) => setNewGroupDescription(e.target.value),
                                placeholder: 'Describe your group. Include any joining criteria or motivational messages to welcome new members.',
                                maxLength: '250'
                            }),
                            React.createElement(
                                'span',
                                { className: 'text-xs mt-1 text-gray-500' },
                                newGroupDescription.length,
                                ' / 250 characters'
                            )
                        )
                    )
                ),
                showCategorySelectionModal && React.createElement(CategorySelectionModal, {
                    onClose: () => setShowCategorySelectionModal(false),
                    onSelectCategory: setNewGroupCategory,
                    selectedCategory: newGroupCategory
                }),
                showDailyGoalSelectionModal && React.createElement(DailyGoalSelectionModal, {
                    onClose: () => setShowDailyGoalSelectionModal(false),
                    onSelectGoal: setNewGroupDailyGoal,
                    selectedGoal: newGroupDailyGoal
                }),
                showCapacitySelectionModal && React.createElement(CapacitySelectionModal, {
                    onClose: () => setShowCapacitySelectionModal(false),
                    onSelectCapacity: setNewGroupCapacity,
                    selectedCapacity: newGroupCapacity
                }),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) })
            );
        }

        // AvailableGroupsView Component
        function AvailableGroupsView({ onBack, onGroupCreated }) {
            const { db, userId, loadingAuth } = useContext(FirebaseContext);
            const [groups, setGroups] = useState([]);
            const [joinedGroupIds, setJoinedGroupIds] = useState(new Set());
            const [showCreateGroupPage, setShowCreateGroupPage] = useState(false);
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);

            const [filterNewGroups, setFilterNewGroups] = useState(true);
            const [filterAvailableGroups, setFilterAvailableGroups] = useState(false);
            const [filterPublicGroups, setFilterPublicGroups] = useState(false);

            useEffect(() => {
                if (!db || !userId || loadingAuth) return;

                const groupsRef = collection(db, `artifacts/${appId}/public/data/studyGroups`);

                const unsubscribe = onSnapshot(groupsRef, (snapshot) => {
                    let fetchedGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (filterNewGroups) {
                        fetchedGroups.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                    }
                    if (filterAvailableGroups) {
                        fetchedGroups = fetchedGroups.filter(group => (group.members?.length || 0) < (group.maxMembers || Infinity));
                    }

                    setGroups(fetchedGroups);

                    const userJoined = new Set();
                    fetchedGroups.forEach(group => {
                        if (group.members && group.members.includes(userId)) {
                            userJoined.add(group.id);
                        }
                    });
                    setJoinedGroupIds(userJoined);

                }, (error) => {
                    console.error("Error fetching study groups:", error);
                    setMessage("Error loading study groups. Please try again.");
                    setShowConfirmation(true);
                });

                return () => unsubscribe();
            }, [db, userId, loadingAuth, filterNewGroups, filterAvailableGroups, filterPublicGroups]);

            const handleJoinGroup = async (groupId, currentMembers, maxMembers) => {
                if (!userId) {
                    setMessage("Authentication not ready. Please wait.");
                    setShowConfirmation(true);
                    return;
                }
                if (currentMembers >= maxMembers) {
                    setMessage("This group has reached its maximum member limit.");
                    setShowConfirmation(true);
                    return;
                }
                try {
                    const groupDocRef = doc(db, `artifacts/${appId}/public/data/studyGroups`, groupId);
                    await updateDoc(groupDocRef, {
                        members: arrayUnion(userId)
                    });
                    setMessage("Joined group successfully!");
                    setShowConfirmation(true);
                } catch (error) {
                    console.error("Error joining group:", error);
                    setMessage("Failed to join group. Please try again.");
                    setShowConfirmation(true);
                }
            };

            const handleLeaveGroup = async (groupId) => {
                if (!userId) {
                    setMessage("Authentication not ready. Please wait.");
                    setShowConfirmation(true);
                    return;
                }
                try {
                    const groupDocRef = doc(db, `artifacts/${appId}/public/data/studyGroups`, groupId);
                    await updateDoc(groupDocRef, {
                        members: arrayRemove(userId)
                    });
                    setMessage("Left group successfully!");
                    setShowConfirmation(true);
                } catch (error) {
                    console.error("Error leaving group:", error);
                    setMessage("Failed to leave group. Please try again.");
                    setShowConfirmation(true);
                }
            };

            if (loadingAuth) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-gray-100 text-gray-700' },
                    React.createElement('p', null, 'Loading authentication...')
                );
            }

            if (showCreateGroupPage) {
                return React.createElement(CreateGroupPage, { onBack: () => setShowCreateGroupPage(false), onGroupCreated: onGroupCreated });
            }

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 flex flex-col font-sans' },
                React.createElement(
                    'div',
                    { className: 'bg-white text-gray-800 p-4 flex justify-between items-center shadow-md' },
                    React.createElement('svg', { onClick: onBack, className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10 19l-7-7m0 0l7-7m-7 7h18' })),
                    React.createElement(
                        'div',
                        { className: 'flex-grow text-center' },
                        React.createElement('h2', { className: 'text-xl font-bold' }, 'Study Group')
                    ),
                    React.createElement('svg', { className: 'w-6 h-6 text-gray-600', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z', clipRule: 'evenodd' }))
                ),
                React.createElement(
                    'div',
                    { className: 'bg-white shadow-md flex justify-around p-3 text-gray-600 font-medium text-lg border-b border-gray-200' },
                    React.createElement('div', { className: 'flex-1 text-center border-b-2 border-blue-600 pb-2 text-blue-600' }, 'New'),
                    React.createElement('div', { className: 'flex-1 text-center pb-2' }, 'Attendance'),
                    React.createElement('div', { className: 'flex-1 text-center pb-2' }, 'Studytime'),
                    React.createElement('div', { className: 'flex-1 text-center pb-2' }, 'Mission'),
                    React.createElement('div', { className: 'flex-1 text-center pb-2' }, 'Leader')
                ),
                React.createElement(
                    'div',
                    { className: 'bg-white p-3 flex justify-end items-center text-gray-700 text-sm border-b border-gray-200' },
                    React.createElement('span', { className: 'mr-4' }, '* The groups will be listed according to the order in which they were created.'),
                    React.createElement(
                        'label',
                        { className: 'inline-flex items-center mr-4' },
                        React.createElement('input', {
                            type: 'checkbox',
                            className: 'form-checkbox h-4 w-4 text-blue-600 rounded',
                            checked: filterAvailableGroups,
                            onChange: () => setFilterAvailableGroups(!filterAvailableGroups)
                        }),
                        React.createElement('span', { className: 'ml-2' }, 'Available')
                    ),
                    React.createElement(
                        'label',
                        { className: 'inline-flex items-center' },
                        React.createElement('input', {
                            type: 'checkbox',
                            className: 'form-checkbox h-4 w-4 text-blue-600 rounded',
                            checked: filterPublicGroups,
                            onChange: () => setFilterPublicGroups(!filterPublicGroups)
                        }),
                        React.createElement('span', { className: 'ml-2' }, 'Public')
                    )
                ),
                React.createElement(
                    'div',
                    { className: 'flex-grow bg-gray-100 p-4 flex flex-col items-center' },
                    groups.length === 0 ? (
                        React.createElement(
                            'div',
                            { className: 'flex-grow flex items-center justify-center text-center text-gray-600 text-lg' },
                            React.createElement('p', null, 'There are no available study groups.')
                        )
                    ) : (
                        React.createElement(
                            'div',
                            { className: 'w-full max-w-4xl' },
                            groups.map(group =>
                                React.createElement(
                                    'div',
                                    {
                                        key: group.id,
                                        className: `bg-white p-4 rounded-lg shadow-md mb-4 border ${joinedGroupIds.has(group.id) ? 'border-blue-500' : 'border-gray-200'} hover:shadow-lg transition duration-200 cursor-pointer`
                                    },
                                    React.createElement(
                                        'div',
                                        { className: 'flex justify-between items-start mb-2' },
                                        React.createElement('h4', { className: 'font-bold text-lg text-gray-900' }, group.name),
                                        React.createElement(
                                            'span',
                                            { className: 'text-sm text-gray-500' },
                                            group.createdAt ? `${Math.round((new Date() - group.createdAt.toDate()) / (1000 * 60))}m ago` : ''
                                        )
                                    ),
                                    React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, group.description),
                                    React.createElement(
                                        'div',
                                        { className: 'text-xs text-gray-500 mb-2' },
                                        React.createElement('p', null, 'Goal: ', group.goal || 'N/A'),
                                        React.createElement('p', null, 'Members: ', group.members ? group.members.length : 0, group.maxMembers ? `/${group.maxMembers} person` : ''),
                                        React.createElement('p', null, 'Attendance: ', group.attendance || 'N/A', '%'),
                                        React.createElement('p', null, 'Time: ', group.studyTime || 'N/A'),
                                        React.createElement('p', null, 'Started on: ', group.createdAt ? group.createdAt.toDate().toLocaleDateString() : 'N/A'),
                                        React.createElement('p', null, 'Leader: ', group.leaderId || 'N/A')
                                    ),
                                    React.createElement(
                                        'div',
                                        { className: 'mt-3 flex justify-end' },
                                        joinedGroupIds.has(group.id) ? (
                                            React.createElement(
                                                'button',
                                                {
                                                    onClick: (e) => { e.stopPropagation(); handleLeaveGroup(group.id); },
                                                    className: 'px-4 py-1 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition'
                                                },
                                                'Leave'
                                            )
                                        ) : (
                                            React.createElement(
                                                'button',
                                                {
                                                    onClick: (e) => { e.stopPropagation(); handleJoinGroup(group.id, group.members?.length || 0, group.maxMembers || Infinity); },
                                                    className: 'px-4 py-1 bg-green-500 text-white rounded-md text-sm hover:bg-green-600 transition',
                                                    disabled: (group.members?.length || 0) >= (group.maxMembers || Infinity)
                                                },
                                                'Join'
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),
                React.createElement(
                    'button',
                    {
                        onClick: () => setShowCreateGroupPage(true),
                        className: 'fixed bottom-20 right-6 bg-orange-500 text-white p-4 rounded-full shadow-lg hover:bg-orange-600 transition duration-300 transform hover:scale-110 z-20',
                        'aria-label': 'Add new study group'
                    },
                    React.createElement('svg', { className: 'w-8 h-8', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z', clipRule: 'evenodd' }))
                ),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) })
            );
        }

        // GroupChat Component
        function GroupChat({ groupId, groupName, onBack }) {
            const { db, userId, user, loadingAuth } = useContext(FirebaseContext);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (!db || !groupId || loadingAuth) return;

                const messagesRef = collection(db, `artifacts/${appId}/public/data/groupChats/${groupId}/messages`);
                const q = query(messagesRef, orderBy('timestamp'));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedMessages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setMessages(fetchedMessages);
                }, (error) => {
                    console.error("Error fetching messages:", error);
                    setMessage("Error loading chat messages. Please try again.");
                    setShowConfirmation(true);
                });

                return () => unsubscribe();
            }, [db, groupId, loadingAuth]);

            useEffect(() => {
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            }, [messages]);

            const handleSendMessage = async () => {
                if (newMessage.trim() === '') {
                    setMessage("Message cannot be empty.");
                    setShowConfirmation(true);
                    return;
                }
                if (!db || !userId) {
                    setMessage("Authentication not ready. Cannot send message.");
                    setShowConfirmation(true);
                    return;
                }

                try {
                    const messagesRef = collection(db, `artifacts/${appId}/public/data/groupChats/${groupId}/messages`);
                    await addDoc(messagesRef, {
                        senderId: userId,
                        senderName: user?.displayName || `User-${userId.substring(0, 4)}`,
                        text: newMessage.trim(),
                        timestamp: serverTimestamp(),
                    });
                    setNewMessage('');
                } catch (error) {
                    console.error("Error sending message:", error);
                    setMessage("Failed to send message. Please try again.");
                    setShowConfirmation(true);
                }
            };

            if (loadingAuth) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-gray-100 text-gray-700' },
                    React.createElement('p', null, 'Loading authentication...')
                );
            }

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 flex flex-col font-sans' },
                React.createElement(
                    'div',
                    { className: 'bg-white text-gray-800 p-4 flex justify-between items-center shadow-md' },
                    React.createElement('svg', { onClick: onBack, className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10 19l-7-7m0 0l7-7m-7 7h18' })),
                    React.createElement('h2', { className: 'text-xl font-bold flex-grow text-center' }, 'Group Chat'),
                    React.createElement(
                        'div',
                        { className: 'flex items-center space-x-4' },
                        React.createElement('svg', { className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 110-6 3 3 0 010 6z' })),
                        React.createElement('svg', { className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2h.01a1 1 0 000-2H9zm1 3a1 1 0 100 2h.01a1 1 0 100-2H10z', clipRule: 'evenodd' }))
                    )
                ),
                React.createElement(
                    'div',
                    { className: 'flex-grow overflow-y-auto p-4 space-y-3 pb-20' },
                    messages.length === 0 ? (
                        React.createElement(
                            'div',
                            { className: 'text-center text-gray-500 mt-8' },
                            'The first message'
                        )
                    ) : (
                        messages.map((msg, index) =>
                            React.createElement(
                                'div',
                                {
                                    key: msg.id || index,
                                    className: `flex ${msg.senderId === userId ? 'justify-end' : 'justify-start'}`
                                },
                                React.createElement(
                                    'div',
                                    {
                                        className: `max-w-[70%] p-3 rounded-lg shadow-sm ${msg.senderId === userId ? 'bg-blue-500 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'}`
                                    },
                                    React.createElement(
                                        'p',
                                        { className: 'text-sm font-semibold mb-1' },
                                        msg.senderId === userId ? 'You' : msg.senderName
                                    ),
                                    React.createElement('p', { className: 'text-base' }, msg.text),
                                    msg.timestamp && React.createElement(
                                        'span',
                                        { className: 'text-xs opacity-75 mt-1 block' },
                                        new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                                    )
                                )
                            )
                        )
                    ),
                    React.createElement('div', { ref: messagesEndRef })
                ),
                React.createElement(
                    'div',
                    { className: 'fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-3 flex items-center shadow-lg z-10' },
                    React.createElement('input', {
                        type: 'text',
                        value: newMessage,
                        onChange: (e) => setNewMessage(e.target.value),
                        onKeyPress: (e) => {
                            if (e.key === 'Enter') {
                                handleSendMessage();
                            }
                        },
                        placeholder: 'Message...',
                        className: 'flex-grow p-3 rounded-full bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800'
                    }),
                    React.createElement(
                        'button',
                        {
                            onClick: handleSendMessage,
                            className: 'ml-3 p-3 bg-blue-600 text-white rounded-full shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center'
                        },
                        React.createElement('svg', { className: 'w-6 h-6 transform rotate-45', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l.445-.445.42.42a1 1 0 001.414 0l1.414-1.414.42.42a1 1 0 001.414 0l1.414-1.414.42.42a1 1 0 001.414 0l.445-.445A1 1 0 0018.894 2.553z' }))
                    )
                ),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) })
            );
        }

        // GroupDetailView Component
        function GroupDetailView({ group, onBack }) {
            const { userId, user, loadingAuth } = useContext(FirebaseContext);
            const [activeSubTab, setActiveSubTab] = useState('home');
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);

            const members = group.members || [];

            const getMemberDetails = (memberId, currentUser) => {
                const mockDetails = {
                    '1': { name: 'Francis', studyTime: '05:11:17', icon: '🎧' },
                    '2': { name: 'Tylg07', studyTime: '02:32:17', icon: '🧑‍💻' },
                    '3': { name: 'Amite', studyTime: '01:33:39', icon: '💻' },
                    '4': { name: 'Markgeoli', studyTime: '01:21:56', icon: '💡' },
                    '5': { name: 'Salma', studyTime: '01:04:03', icon: '⭐' },
                    '6': { name: 'clarisyy', studyTime: '00:54:57', icon: '📚' },
                    '7': { name: 'Elexvg', studyTime: '00:36:28', icon: '⏰' },
                    '8': { name: 'spherical.rat', studyTime: '00:31:35', icon: '🐀' },
                    '9': { name: 'bbyyunseul', studyTime: '00:21:47', icon: '📱' },
                    [userId]: { name: currentUser?.displayName || `You (${memberId.substring(0, 4)})`, studyTime: '00:00:00', icon: '👑' },
                    '11': { name: 'Flamme.A.W.', studyTime: '00:00:00', icon: '🔥' },
                    '12': { name: 'high achiever', studyTime: '00:00:00', icon: '🤩' },
                    '13': { name: 'z_m759', studyTime: '00:00:00', icon: '💤' },
                    '14': { name: '+Tylg', studyTime: '00:00:00', icon: '💖' },
                    '15': { name: 'JakubW', studyTime: '00:00:00', icon: '💡' },
                    '16': { name: 'kasper', studyTime: '00:00:00', icon: '👻' },
                    '17': { name: 'henriz', studyTime: '00:00:00', icon: '📖' },
                    '18': { name: 'zuzup', studyTime: '00:00:00', icon: '✍️' },
                    '19': { name: 'Chléaaa♡D♡', studyTime: '00:00:00', icon: '🌸' },
                    '20': { name: 'Aminacore', studyTime: '00:00:00', icon: '✨' },
                };
                return mockDetails[memberId] || { name: `User-${memberId.substring(0, 4)}`, studyTime: '00:00:00', icon: '👤' };
            };

            if (loadingAuth) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-gray-100 text-gray-700' },
                    React.createElement('p', null, 'Loading authentication...')
                );
            }

            const handleSubTabClick = (tabName) => {
                setActiveSubTab(tabName);
            };

            const renderGroupContent = () => {
                switch (activeSubTab) {
                    case 'home':
                        return React.createElement(
                            React.Fragment,
                            null,
                            React.createElement(
                                'div',
                                { className: 'bg-white p-4 mx-4 mt-4 rounded-lg shadow-md flex justify-between items-center text-gray-700 cursor-pointer' },
                                React.createElement('span', null, 'Group Introduction/Rules'),
                                React.createElement('svg', { className: 'w-5 h-5 text-gray-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M9 5l7 7-7 7' }))
                            ),
                            React.createElement(
                                'div',
                                { className: 'flex-grow bg-gray-100 p-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 overflow-y-auto pb-16' },
                                members.map(memberId => {
                                    const memberDetails = getMemberDetails(memberId, user);
                                    return React.createElement(
                                        'div',
                                        {
                                            key: memberId,
                                            className: `flex flex-col items-center justify-center p-3 rounded-lg shadow-sm text-center ${memberId === userId ? 'bg-orange-100 border-2 border-orange-400' : 'bg-white border border-gray-200'}`
                                        },
                                        React.createElement(
                                            'div',
                                            { className: 'w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-2xl mb-2' },
                                            memberDetails.icon
                                        ),
                                        React.createElement('p', { className: 'text-sm font-medium text-gray-800 truncate w-full' }, memberDetails.name),
                                        React.createElement('p', { className: 'text-xs text-gray-500' }, memberDetails.studyTime)
                                    );
                                })
                            )
                        );
                    case 'attendance':
                    case 'rankings':
                    case 'invite':
                        return React.createElement(
                            'div',
                            { className: 'flex-grow flex items-center justify-center text-center text-gray-600 text-lg' },
                            React.createElement('p', null, activeSubTab, ' functionality to be implemented.')
                        );
                    case 'chat':
                        return React.createElement(GroupChat, { groupId: group.id, groupName: group.name, onBack: onBack });
                    default:
                        return null;
                }
            };

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 flex flex-col font-sans' },
                React.createElement(
                    'div',
                    { className: 'bg-white text-gray-800 p-4 flex justify-between items-center shadow-md' },
                    React.createElement('svg', { onClick: onBack, className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10 19l-7-7m0 0l7-7m-7 7h18' })),
                    React.createElement('h2', { className: 'text-xl font-bold flex-grow text-center' }, group.name),
                    React.createElement('svg', { className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.33.83 2.864 2.334l-.067.223a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.83 3.33-2.334 2.864l-.223-.067a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942.83-3.33 2.334-2.864l.223.067a1.724 1.724 0 002.573-1.066z' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' }))
                ),
                renderGroupContent(),
                activeSubTab !== 'chat' && React.createElement(
                    'div',
                    { className: 'bg-white border-t border-gray-200 p-3 flex justify-around items-center shadow-lg fixed bottom-0 left-0 w-full z-10' },
                    React.createElement(
                        'div',
                        {
                            className: `flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'home' ? 'text-blue-600' : 'text-gray-500'}`,
                            onClick: () => handleSubTabClick('home')
                        },
                        React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M3 12l9-9 9 9H3zm.75 1.5h16.5V21H3.75v-7.5z' })),
                        React.createElement('span', { className: 'text-xs mt-1' }, 'Home')
                    ),
                    React.createElement(
                        'div',
                        {
                            className: `flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'attendance' ? 'text-blue-600' : 'text-gray-500'}`,
                            onClick: () => handleSubTabClick('attendance')
                        },
                        React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M19 4h-2V2h-2v2H9V2H7v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM5 7V6h14v1H5z' })),
                        React.createElement('span', { className: 'text-xs mt-1' }, 'Attendance')
                    ),
                    React.createElement(
                        'div',
                        {
                            className: `flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'rankings' ? 'text-blue-600' : 'text-gray-500'}`,
                            onClick: () => handleSubTabClick('rankings')
                        },
                        React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M4 22H2V2h2v20zM8 10h2V2h-2v8zm4 8h2V2h-2v16zm4-4h2V2h-2v12zm4-4h2V2h-2v8z' })),
                        React.createElement('span', { className: 'text-xs mt-1' }, 'Rankings')
                    ),
                    React.createElement(
                        'div',
                        {
                            className: `flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'invite' ? 'text-blue-600' : 'text-gray-500'}`,
                            onClick: () => handleSubTabClick('invite')
                        },
                        React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z' })),
                        React.createElement('span', { className: 'text-xs mt-1' }, 'Invite')
                    ),
                    React.createElement(
                        'div',
                        {
                            className: `flex flex-col items-center cursor-pointer p-2 rounded-md transition-colors duration-200 ${activeSubTab === 'chat' ? 'text-blue-600' : 'text-gray-500'}`,
                            onClick: () => handleSubTabClick('chat')
                        },
                        React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z' })),
                        React.createElement('span', { className: 'text-xs mt-1' }, 'Chat')
                    )
                ),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) })
            );
        }

        // SetProfilePage Component
        function SetProfilePage({ onProfileSetupComplete }) {
            const { auth, user, db, userId, setUser } = useContext(FirebaseContext);
            const [displayName, setDisplayName] = useState('');
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);

            useEffect(() => {
                if (user?.displayName) {
                    setDisplayName(user.displayName);
                }
            }, [user]);

            const handleSaveProfile = async () => {
                if (displayName.trim() === '') {
                    setMessage('Display name cannot be empty.');
                    setShowConfirmation(true);
                    return;
                }

                if (!user) {
                    setMessage('No user authenticated.');
                    setShowConfirmation(true);
                    return;
                }

                try {
                    await updateProfile(user, { displayName: displayName.trim() });

                    if (db && userId) {
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'public');
                        await setDoc(userDocRef, {
                            displayName: displayName.trim(),
                            uid: userId,
                        }, { merge: true });
                    }

                    setMessage('Profile updated successfully!');
                    setShowConfirmation(true);

                    setUser({ ...user, displayName: displayName.trim() });

                    setTimeout(() => {
                        onProfileSetupComplete();
                    }, 1500);

                } catch (error) {
                    console.error("Error updating profile:", error);
                    setMessage(`Failed to update profile: ${error.message}`);
                    setShowConfirmation(true);
                }
            };

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4 font-sans' },
                React.createElement(
                    'div',
                    { className: 'bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center' },
                    React.createElement('h2', { className: 'text-2xl font-bold text-gray-800 mb-6' }, 'Set Up Your Profile'),
                    React.createElement(
                        'div',
                        { className: 'w-24 h-24 bg-blue-200 rounded-full flex items-center justify-center text-5xl text-blue-800 mx-auto mb-6' },
                        displayName ? displayName.charAt(0).toUpperCase() : '👤'
                    ),
                    React.createElement(
                        'div',
                        { className: 'mb-6' },
                        React.createElement(
                            'label',
                            { htmlFor: 'displayName', className: 'block text-gray-700 text-left text-sm font-medium mb-2' },
                            'Display Name'
                        ),
                        React.createElement('input', {
                            type: 'text',
                            id: 'displayName',
                            placeholder: 'Enter your display name',
                            value: displayName,
                            onChange: (e) => setDisplayName(e.target.value),
                            className: 'w-full py-3 px-4 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-400',
                            maxLength: '20'
                        }),
                        React.createElement(
                            'span',
                            { className: 'text-xs text-gray-500 mt-1 block text-right' },
                            displayName.length,
                            ' / 20'
                        )
                    ),
                    React.createElement(
                        'button',
                        {
                            onClick: handleSaveProfile,
                            className: 'w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-200 text-lg'
                        },
                        'Save Profile'
                    )
                ),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) })
            );
        }

        // MorePage Component
        function MorePage({ setActiveTab }) {
            const { userId, user } = useContext(FirebaseContext);
            const [message, setMessage] = useState('');
            const [showConfirmation, setShowConfirmation] = useState(false);

            const handleFeatureClick = (featureName) => {
                setMessage(`${featureName} functionality to be implemented.`);
                setShowConfirmation(true);
            };

            return React.createElement(
                'div',
                { className: 'min-h-screen bg-gray-100 flex flex-col font-sans' },
                React.createElement(
                    'div',
                    { className: 'bg-white text-gray-800 p-4 flex justify-between items-center shadow-md' },
                    React.createElement('h2', { className: 'text-xl font-bold flex-grow text-center' }, 'More'),
                    React.createElement('svg', { className: 'w-6 h-6 text-gray-600 cursor-pointer', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.33.83 2.864 2.334l-.067.223a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.83 3.33-2.334 2.864l-.223-.067a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942.83-3.33 2.334-2.864l.223.067a1.724 1.724 0 002.573-1.066z' }), React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' }))
                ),
                React.createElement(
                    'div',
                    { className: 'bg-white p-4 rounded-lg shadow-md mx-4 mt-4 flex items-center' },
                    React.createElement(
                        'div',
                        { className: 'w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mr-4' },
                        React.createElement(
                            'span',
                            { className: 'text-xl text-gray-600' },
                            user?.displayName ? user.displayName.charAt(0).toUpperCase() : '👤'
                        )
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('p', { className: 'font-semibold text-lg text-gray-800' }, user?.displayName || 'Guest User'),
                        React.createElement('p', { className: 'text-sm text-gray-500' }, 'No Status Message.')
                    ),
                    React.createElement(
                        'div',
                        { className: 'ml-auto' },
                        React.createElement('svg', { className: 'w-8 h-8 text-orange-500', fill: 'currentColor', viewBox: '0 0 24 24', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z' }))
                    )
                ),
                React.createElement(
                    'div',
                    { className: 'text-center text-xs text-gray-400 mt-2 mb-4' },
                    'AD'
                ),
                React.createElement(
                    'div',
                    { className: 'bg-white rounded-lg shadow-md mx-4 mb-4 overflow-hidden' },
                    React.createElement(
                        'div',
                        { className: 'border-b border-gray-200' },
                        React.createElement(
                            'button',
                            {
                                onClick: () => setActiveTab('leaderboard'),
                                className: 'flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150'
                            },
                            React.createElement('svg', { className: 'w-6 h-6 mr-3 text-gray-500', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M10 2a8 8 0 100 16 8 8 0 000-16zM6.5 9a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm7 0a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm-3.5 6a1.5 1.5 0 100-3 1.5 1.5 0 000 3z', clipRule: 'evenodd' })),
                            'Rankings'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'border-b border-gray-200' },
                        React.createElement(
                            'button',
                            {
                                onClick: () => handleFeatureClick('Calendar'),
                                className: 'flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150'
                            },
                            React.createElement('svg', { className: 'w-6 h-6 mr-3 text-gray-500', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z', clipRule: 'evenodd' })),
                            'Calendar'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'border-b border-gray-200' },
                        React.createElement(
                            'button',
                            {
                                onClick: () => handleFeatureClick('YPT Store'),
                                className: 'flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150'
                            },
                            React.createElement('svg', { className: 'w-6 h-6 mr-3 text-orange-500', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10.586l2 2H14a2 2 0 00-2 2v4a2 2 0 002 2h2a2 2 0 002-2v-4a2 2 0 00-2-2h-1.414l-2-2H4z', clipRule: 'evenodd' })),
                            'YPT Store'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'border-b border-gray-200' },
                        React.createElement(
                            'button',
                            {
                                onClick: () => handleFeatureClick('Studicon Settings'),
                                className: 'flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150'
                            },
                            React.createElement('svg', { className: 'w-6 h-6 mr-3 text-gray-500', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm-1 6a1 1 0 100 2h.01a1 1 0 100-2H10z', clipRule: 'evenodd' })),
                            'Studicon Settings'
                        )
                    ),
                    React.createElement(
                        'div',
                        { className: 'border-b border-gray-200' },
                        React.createElement(
                            'button',
                            {
                                onClick: () => handleFeatureClick('Invite Friends'),
                                className: 'flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150'
                            },
                            React.createElement('svg', { className: 'w-6 h-6 mr-3 text-gray-500', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { d: 'M13 6a3 3 0 11-6 0 3 3 0 016 0zm-6 9a3 3 0 100-6 3 3 0 000 6zm7 0a3 3 0 100-6 3 3 0 000 6z' })),
                            'Invite Friends'
                        )
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement(
                            'button',
                            {
                                onClick: () => handleFeatureClick('Help'),
                                className: 'flex items-center w-full p-4 text-lg text-gray-800 hover:bg-gray-50 transition duration-150'
                            },
                            React.createElement('svg', { className: 'w-6 h-6 mr-3 text-gray-500', fill: 'currentColor', viewBox: '0 0 20 20', xmlns: 'http://www.w3.org/2000/svg' }, React.createElement('path', { fillRule: 'evenodd', d: 'M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.442C7.26 8.21 6 10.112 6 12a2 2 0 002 2h2a2 2 0 002-2c0-1.888-1.26-3.79-3.133-4.558A1 1 0 0010 7z', clipRule: 'evenodd' })),
                            'Help'
                        )
                    )
                ),
                showConfirmation && React.createElement(ConfirmationModal, { message: message, onClose: () => setShowConfirmation(false) })
            );
        }

        // App Component (Main)
        function App() {
            const [activeTab, setActiveTab] = useState('timer');
            const [selectedGroupInStudyGroup, setSelectedGroupInStudyGroup] = useState(null);
            const firebaseData = useFirebase();
            const { user, loadingAuth } = firebaseData;

            const renderContent = () => {
                if (loadingAuth) {
                    return React.createElement(
                        'div',
                        { className: 'flex items-center justify-center min-h-screen bg-gray-100 text-gray-700' },
                        React.createElement('p', null, 'Loading authentication...')
                    );
                }

                if (!user) {
                    return React.createElement(WelcomeScreen, { onAuthSuccess: () => { /* Handled by useFirebase's onAuthStateChanged */ } });
                }

                if (!user.displayName) {
                    return React.createElement(SetProfilePage, { onProfileSetupComplete: () => { } });
                }

                switch (activeTab) {
                    case 'timer':
                        return React.createElement(Timer, null);
                    case 'stats':
                        return React.createElement(Stats, null);
                    case 'leaderboard':
                        return React.createElement(Leaderboard, null);
                    case 'study-group':
                        return React.createElement(StudyGroup, { setSelectedGroupInStudyGroup: setSelectedGroupInStudyGroup });
                    case 'more':
                        return React.createElement(MorePage, { setActiveTab: setActiveTab });
                    default:
                        return React.createElement(Timer, null);
                }
            };

            return React.createElement(
                FirebaseContext.Provider,
                { value: firebaseData },
                React.createElement(
                    'div',
                    { className: 'min-h-screen bg-gray-100 font-sans text-gray-900 flex flex-col' },
                    React.createElement(
                        'main',
                        { className: 'flex-grow' },
                        renderContent()
                    ),
                    user && user.displayName && (activeTab !== 'study-group' || !selectedGroupInStudyGroup) ? (
                        React.createElement(Navbar, { setActiveTab: setActiveTab, activeTab: activeTab })
                    ) : null
                )
            );
        }

        // Render the React App component into the root div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(App, null));
    </script>
</body>
</html>
